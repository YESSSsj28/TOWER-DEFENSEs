<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chayt - Secure Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Base Colors */
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --sent-bg: #4338ca;
      --received-bg: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --border-radius: 16px;
      --transition: all 0.3s ease;
      
      /* Role Colors */
      --owner-color: #f43f5e;
      --member-color: #94a3b8;
      
      /* New UI Elements */
      --sidebar-width: 280px;
      --header-height: 60px;
      --input-height: 80px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      background-image: radial-gradient(circle at 10% 20%, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.8) 90%);
    }

    /* Layout */
    .app-container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: rgba(15, 23, 42, 0.8);
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .friends-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .friend-item {
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: var(--transition);
    }

    .friend-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .friend-item.active {
      background: rgba(99, 102, 241, 0.2);
    }

    .friend-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .friend-name {
      flex: 1;
      font-size: 14px;
    }

    .friend-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .status-online {
      background: var(--success);
    }

    .status-offline {
      background: var(--text-secondary);
    }

    .status-away {
      background: var(--warning);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 16px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
    }

    .chat-header h3 {
      font-size: 18px;
      background: linear-gradient(90deg, #8b5cf6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .chat-actions {
      display: flex;
      gap: 12px;
    }

    .chat-actions button {
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(99, 102, 241, 0.2);
    }

    .chat-actions button:hover {
      background: rgba(99, 102, 241, 0.3);
    }

    /* Messages */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.3s ease;
      line-height: 1.5;
      word-wrap: break-word;
      transition: var(--transition);
    }

    .message.sent {
      background: var(--sent-bg);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      background: var(--received-bg);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message .timestamp {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 6px;
      text-align: right;
    }

    .message img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 8px;
      display: block;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .owner-badge {
      background: linear-gradient(90deg, #f43f5e, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
      font-size: 0.8em;
      margin-left: 5px;
    }

    /* Input Area */
    .input-area {
      padding: 16px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-row {
      display: flex;
      gap: 12px;
    }

    .input-row textarea {
      flex: 1;
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 16px;
      transition: var(--transition);
      resize: none;
      min-height: 50px;
      max-height: 150px;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .input-row textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .input-row textarea::placeholder {
      color: var(--text-secondary);
    }

    /* Image Preview */
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: none;
    }

    .image-preview.visible {
      display: block;
    }

    .remove-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--error);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .image-preview-container {
      position: relative;
      display: inline-block;
    }

    /* Auth Styles */
    #auth-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.5s ease;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .auth-header h2 {
      background: linear-gradient(90deg, #8b5cf6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .auth-tab.active {
      background: var(--accent);
      font-weight: 600;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    input {
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 16px;
      transition: var(--transition);
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    input::placeholder {
      color: var(--text-secondary);
    }

    button {
      padding: 14px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      margin-top: 8px;
      transition: var(--transition);
    }

    .status.success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .status.loading {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    /* File Input */
    .file-input-container {
      position: relative;
      flex: 1;
    }

    .file-input-container input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-input-container .custom-file-input {
      padding: 14px 24px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      transition: var(--transition);
    }

    .file-input-container:hover .custom-file-input {
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.7);
    }

    .btn-group {
      display: flex;
      gap: 12px;
    }

    /* Password Visibility Toggle */
    .password-container {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: var(--text-secondary);
    }

    .password-input {
      padding-right: 35px !important;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: var(--transition);
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: var(--transition);
    }

    .modal.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 {
      font-size: 20px;
      background: linear-gradient(90deg, #8b5cf6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
    }

    /* Friend Request Badge */
    .request-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--error);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    /* Background Options */
    .bg-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .bg-option {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      height: 80px;
      border: 2px solid transparent;
      transition: var(--transition);
    }

    .bg-option:hover {
      transform: translateY(-2px);
    }

    .bg-option.active {
      border-color: var(--accent);
    }

    .bg-option .bg-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      padding: 4px;
      text-align: center;
      font-size: 12px;
    }

    /* Friend Checkbox */
    .friend-checkbox {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 4px;
      transition: var(--transition);
    }

    .friend-checkbox:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .friend-checkbox input {
      margin-right: 8px;
    }

    /* Request Item */
    .request-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
    }

    .request-actions {
      display: flex;
      gap: 8px;
    }

    .request-actions button {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Add Friends to Group */
    .add-friends-container {
      margin-top: 16px;
    }

    /* User Profile */
    .user-profile {
      padding: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .profile-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      position: relative;
      cursor: pointer;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 18px;
      font-weight: bold;
    }

    .profile-description {
      color: var(--text-secondary);
      font-size: 14px;
      text-align: center;
      margin-bottom: 12px;
    }

    .profile-edit-btn {
      width: 100%;
      margin-top: 12px;
    }

    .profile-edit-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Profile Preview in Messages */
    .message-user-profile {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .message-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-card);
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .message-user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .message-username {
      font-weight: bold;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 80px;
      }
      
      .friend-name {
        display: none;
      }
      
      .friend-avatar {
        margin-right: 0;
      }
    }

    @media (max-width: 600px) {
      .btn-group {
        flex-direction: column;
      }
      
      .input-row {
        flex-direction: column;
      }
      
      .message {
        max-width: 90%;
      }
      
      .bg-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Animated Backgrounds */
    .animated-bg-1 {
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    .animated-bg-2 {
      background: linear-gradient(-45deg, #6366f1, #8b5cf6, #ec4899, #f43f5e);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div id="auth-container">
    <div class="auth-header">
      <h2>Welcome to Chayt</h2>
      <p>Secure real-time messaging</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" id="login-tab">Sign In</div>
      <div class="auth-tab" id="register-tab">Sign Up</div>
    </div>

    <div class="auth-form" id="login-form">
      <div class="input-group">
        <label for="login-username">Username</label>
        <input type="text" id="login-username" placeholder="Enter your username">
      </div>

      <div class="input-group">
        <label for="login-password">Password</label>
        <div class="password-container">
          <input type="password" id="login-password" class="password-input" placeholder="Enter your password">
          <i class="fas fa-eye toggle-password" id="toggle-login-password"></i>
        </div>
      </div>

      <button id="login-btn">
        <i class="fas fa-sign-in-alt"></i>
        <span>Sign In</span>
      </button>

      <div id="login-status" class="status"></div>
    </div>

    <div class="auth-form" id="register-form" style="display: none;">
      <div class="input-group">
        <label for="register-username">Username</label>
        <input type="text" id="register-username" placeholder="Choose a username">
      </div>

      <div class="input-group">
        <label for="register-password">Password</label>
        <div class="password-container">
          <input type="password" id="register-password" class="password-input" placeholder="Create a password">
          <i class="fas fa-eye toggle-password" id="toggle-register-password"></i>
        </div>
      </div>

      <div class="input-group">
        <label for="confirm-password">Confirm Password</label>
        <div class="password-container">
          <input type="password" id="confirm-password" class="password-input" placeholder="Confirm your password">
          <i class="fas fa-eye toggle-password" id="toggle-confirm-password"></i>
        </div>
      </div>

      <button id="register-btn">
        <i class="fas fa-user-plus"></i>
        <span>Create Account</span>
      </button>

      <div id="register-status" class="status"></div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="app-container" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="friends-list" id="friends-list">
        <div class="friend-item" id="add-friend-btn">
          <div class="friend-avatar"><i class="fas fa-user-plus"></i></div>
          <div class="friend-name">Add Friend</div>
        </div>
        <div class="friend-item" id="friend-requests-btn">
          <div class="friend-avatar"><i class="fas fa-user-clock"></i></div>
          <div class="friend-name">Friend Requests</div>
          <div id="request-badge" class="request-badge" style="display: none;"></div>
        </div>
        <div class="friend-item" id="create-group-btn">
          <div class="friend-avatar"><i class="fas fa-users"></i></div>
          <div class="friend-name">Create Group</div>
        </div>
        <!-- Friends and groups will be added here dynamically -->
      </div>
      
      <!-- User Profile -->
      <div class="user-profile">
        <div class="profile-view" id="profile-view">
          <div class="profile-avatar" id="profile-avatar">
            <span id="profile-avatar-text">U</span>
            <img id="profile-avatar-img" style="display: none;">
          </div>
          <div class="profile-name" id="profile-name">User</div>
          <div class="profile-description" id="profile-description">No description yet</div>
          <button class="profile-edit-btn" id="profile-edit-btn">
            <i class="fas fa-edit"></i>
            <span>Edit Profile</span>
          </button>
        </div>
        <div class="profile-edit-form" id="profile-edit-form" style="display: none;">
          <div class="input-group">
            <label>Profile Picture</label>
            <div class="file-input-container">
              <input type="file" id="profile-picture-upload" accept="image/*">
              <div class="custom-file-input">
                <i class="fas fa-image"></i>
                <span>Choose Image</span>
              </div>
            </div>
          </div>
          <div class="input-group">
            <label for="profile-description-input">Description</label>
            <textarea id="profile-description-input" placeholder="Tell us about yourself"></textarea>
          </div>
          <button id="save-profile-btn">
            <i class="fas fa-save"></i>
            <span>Save Profile</span>
          </button>
          <button id="cancel-profile-edit-btn" style="background: var(--bg-card);">
            <i class="fas fa-times"></i>
            <span>Cancel</span>
          </button>
        </div>
        <button class="logout-btn" id="logout-btn" style="width: 100%; margin-top: 12px;">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
        <button class="settings-btn" id="settings-btn" style="width: 100%; margin-top: 12px;">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-header">
          <h3 id="chat-title">Direct Messages</h3>
          <div class="chat-actions" id="chat-actions" style="display: none;">
            <button id="add-friends-to-group-btn"><i class="fas fa-user-plus"></i> Add Friends</button>
            <button id="leave-group-btn"><i class="fas fa-sign-out-alt"></i> Leave</button>
            <button id="kick-member-btn"><i class="fas fa-user-minus"></i> Kick</button>
          </div>
        </div>

        <div id="messages"></div>
        
        <div class="input-area">
          <div class="image-preview-container">
            <img id="image-preview" class="image-preview" src="" alt="Image preview">
            <button id="remove-image-btn" class="remove-image-btn" style="display: none;">×</button>
          </div>
          <div class="input-row">
            <textarea id="message" placeholder="Type your message..." autocomplete="off" rows="1"></textarea>
            <button id="send-text-btn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          
          <div class="btn-group">
            <div class="file-input-container">
              <input type="file" id="upload" accept="image/*">
              <div class="custom-file-input">
                <i class="fas fa-image"></i>
                <span>Choose Image</span>
              </div>
            </div>
            
            <button id="send-image-btn" disabled>
              <i class="fas fa-upload"></i>
              <span>Send Image</span>
            </button>
          </div>
          
          <div id="chat-status" class="status"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Friend Modal -->
  <div class="modal" id="add-friend-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Friend</h3>
        <button class="modal-close" id="close-add-friend">&times;</button>
      </div>
      <div class="input-group">
        <label for="friend-username">Username</label>
        <input type="text" id="friend-username" placeholder="Enter friend's username">
      </div>
      <button id="send-request-btn" style="margin-top: 16px;">
        <i class="fas fa-user-plus"></i>
        <span>Send Request</span>
      </button>
      <div id="friend-status" class="status"></div>
    </div>
  </div>

  <!-- Friend Requests Modal -->
  <div class="modal" id="requests-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Friend Requests</h3>
        <button class="modal-close" id="close-requests">&times;</button>
      </div>
      <div id="requests-list">
        <!-- Requests will be added here dynamically -->
      </div>
      <div id="requests-status" class="status"></div>
    </div>
  </div>

  <!-- Create Group Modal -->
  <div class="modal" id="create-group-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Group Chat</h3>
        <button class="modal-close" id="close-create-group">&times;</button>
      </div>
      <div class="input-group">
        <label for="group-name">Group Name</label>
        <input type="text" id="group-name" placeholder="Enter group name">
      </div>
      <div class="input-group">
        <label>Add Members</label>
        <div id="friends-to-add">
          <!-- Friends will be listed here for selection -->
        </div>
      </div>
      <button id="create-group-confirm-btn" style="margin-top: 16px;">
        <i class="fas fa-users"></i>
        <span>Create Group</span>
      </button>
      <div id="group-status" class="status"></div>
    </div>
  </div>

  <!-- Add Friends to Group Modal -->
  <div class="modal" id="add-friends-to-group-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Friends to Group</h3>
        <button class="modal-close" id="close-add-friends-to-group">&times;</button>
      </div>
      <div class="input-group">
        <div id="friends-to-add-to-group">
          <!-- Friends will be listed here for selection -->
        </div>
      </div>
      <button id="add-friends-to-group-confirm-btn" style="margin-top: 16px;">
        <i class="fas fa-user-plus"></i>
        <span>Add Friends</span>
      </button>
      <div id="add-friends-status" class="status"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Appearance Settings</h3>
        <button class="modal-close" id="close-settings">&times;</button>
      </div>
      <div class="input-group">
        <label>Background</label>
        <div class="bg-grid">
          <div class="bg-option active" data-bg="default">
            <div style="background: #0f172a; height: 100%; background-image: radial-gradient(circle at 10% 20%, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.8) 90%);"></div>
            <div class="bg-label">Default</div>
          </div>
          <div class="bg-option" data-bg="animated-1">
            <div class="animated-bg-1" style="height: 100%;"></div>
            <div class="bg-label">Animated 1</div>
          </div>
          <div class="bg-option" data-bg="animated-2">
            <div class="animated-bg-2" style="height: 100%;"></div>
            <div class="bg-label">Animated 2</div>
          </div>
          <div class="bg-option" data-bg="gradient-purple">
            <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); height: 100%;"></div>
            <div class="bg-label">Purple</div>
          </div>
          <div class="bg-option" data-bg="gradient-blue">
            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); height: 100%;"></div>
            <div class="bg-label">Blue</div>
          </div>
          <div class="bg-option" data-bg="gradient-red">
            <div style="background: linear-gradient(135deg, #ef4444, #b91c1c); height: 100%;"></div>
            <div class="bg-label">Red</div>
          </div>
          <div class="bg-option" data-bg="gradient-green">
            <div style="background: linear-gradient(135deg, #10b981, #047857); height: 100%;"></div>
            <div class="bg-label">Green</div>
          </div>
          <div class="bg-option" data-bg="gradient-orange">
            <div style="background: linear-gradient(135deg, #f59e0b, #b45309); height: 100%;"></div>
            <div class="bg-label">Orange</div>
          </div>
          <div class="bg-option" data-bg="black">
            <div style="background: #000; height: 100%;"></div>
            <div class="bg-label">Black</div>
          </div>
          <div class="bg-option" data-bg="white">
            <div style="background: #fff; height: 100%;"></div>
            <div class="bg-label">White</div>
          </div>
        </div>
      </div>
      <button id="save-settings-btn" style="margin-top: 16px;">
        <i class="fas fa-save"></i>
        <span>Save Settings</span>
      </button>
      <div id="settings-status" class="status"></div>
    </div>
  </div>

  <!-- Profile View Modal -->
  <div class="modal" id="profile-view-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="profile-modal-title">User Profile</h3>
        <button class="modal-close" id="close-profile-view">&times;</button>
      </div>
      <div class="profile-view" id="profile-modal-view">
        <div class="profile-avatar" id="profile-modal-avatar">
          <span id="profile-modal-avatar-text">U</span>
          <img id="profile-modal-avatar-img" style="display: none;">
        </div>
        <div class="profile-name" id="profile-modal-name">User</div>
        <div class="profile-description" id="profile-modal-description">No description yet</div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD9uzP781-TlDSC9fILQX8M-Xa7Ely_rZc",
      authDomain: "chayt-41951.firebaseapp.com",
      projectId: "chayt-41951",
      storageBucket: "chayt-41951.appspot.com",
      messagingSenderId: "841659925542",
      appId: "1:841659925542:web:ba7751ee2a97b5fcf452e7",
      databaseURL: "https://chayt-41951-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginStatus = document.getElementById('login-status');
    const registerStatus = document.getElementById('register-status');
    const chatStatus = document.getElementById('chat-status');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message');
    const uploadInput = document.getElementById('upload');
    const sendTextBtn = document.getElementById('send-text-btn');
    const sendImageBtn = document.getElementById('send-image-btn');
    const friendsList = document.getElementById('friends-list');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const friendRequestsBtn = document.getElementById('friend-requests-btn');
    const createGroupBtn = document.getElementById('create-group-btn');
    const requestBadge = document.getElementById('request-badge');
    const addFriendModal = document.getElementById('add-friend-modal');
    const closeAddFriend = document.getElementById('close-add-friend');
    const sendRequestBtn = document.getElementById('send-request-btn');
    const friendUsernameInput = document.getElementById('friend-username');
    const friendStatus = document.getElementById('friend-status');
    const requestsModal = document.getElementById('requests-modal');
    const closeRequests = document.getElementById('close-requests');
    const requestsList = document.getElementById('requests-list');
    const requestsStatus = document.getElementById('requests-status');
    const createGroupModal = document.getElementById('create-group-modal');
    const closeCreateGroup = document.getElementById('close-create-group');
    const createGroupConfirmBtn = document.getElementById('create-group-confirm-btn');
    const groupNameInput = document.getElementById('group-name');
    const friendsToAdd = document.getElementById('friends-to-add');
    const groupStatus = document.getElementById('group-status');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const settingsStatus = document.getElementById('settings-status');
    const chatTitle = document.getElementById('chat-title');
    const chatActions = document.getElementById('chat-actions');
    const addFriendsToGroupBtn = document.getElementById('add-friends-to-group-btn');
    const leaveGroupBtn = document.getElementById('leave-group-btn');
    const kickMemberBtn = document.getElementById('kick-member-btn');
    const addFriendsToGroupModal = document.getElementById('add-friends-to-group-modal');
    const closeAddFriendsToGroup = document.getElementById('close-add-friends-to-group');
    const addFriendsToGroupConfirmBtn = document.getElementById('add-friends-to-group-confirm-btn');
    const friendsToAddToGroup = document.getElementById('friends-to-add-to-group');
    const addFriendsStatus = document.getElementById('add-friends-status');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const profileView = document.getElementById('profile-view');
    const profileEditForm = document.getElementById('profile-edit-form');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileAvatarText = document.getElementById('profile-avatar-text');
    const profileAvatarImg = document.getElementById('profile-avatar-img');
    const profileName = document.getElementById('profile-name');
    const profileDescription = document.getElementById('profile-description');
    const profileEditBtn = document.getElementById('profile-edit-btn');
    const profilePictureUpload = document.getElementById('profile-picture-upload');
    const profileDescriptionInput = document.getElementById('profile-description-input');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const cancelProfileEditBtn = document.getElementById('cancel-profile-edit-btn');
    const profileViewModal = document.getElementById('profile-view-modal');
    const closeProfileView = document.getElementById('close-profile-view');
    const profileModalTitle = document.getElementById('profile-modal-title');
    const profileModalAvatar = document.getElementById('profile-modal-avatar');
    const profileModalAvatarText = document.getElementById('profile-modal-avatar-text');
    const profileModalAvatarImg = document.getElementById('profile-modal-avatar-img');
    const profileModalName = document.getElementById('profile-modal-name');
    const profileModalDescription = document.getElementById('profile-modal-description');
    const toggleLoginPassword = document.getElementById('toggle-login-password');
    const toggleRegisterPassword = document.getElementById('toggle-register-password');
    const toggleConfirmPassword = document.getElementById('toggle-confirm-password');

    // Current User and App State
    let currentUser = null;
    let currentChat = null;
    let friends = [];
    let pendingRequests = [];
    let groups = [];
    let currentGroupMembers = [];
    let selectedImage = null;
    let profilePictureFile = null;
    let chatActivity = {}; // Tracks last activity time for each chat

    // Initialize the app
    function init() {
      checkAuth();
      setupEventListeners();
      setupTextareaAutoResize();
    }

    // Set up event listeners
    function setupEventListeners() {
      // Auth tabs
      loginTab.addEventListener('click', () => {
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
        loginForm.style.display = 'flex';
        registerForm.style.display = 'none';
      });

      registerTab.addEventListener('click', () => {
        registerTab.classList.add('active');
        loginTab.classList.remove('active');
        registerForm.style.display = 'flex';
        loginForm.style.display = 'none';
      });

      // Auth buttons
      registerBtn.addEventListener('click', registerUser);
      loginBtn.addEventListener('click', loginUser);
      logoutBtn.addEventListener('click', logoutUser);

      // Password visibility toggles
      toggleLoginPassword.addEventListener('click', function() {
        togglePasswordVisibility('login-password', this);
      });

      toggleRegisterPassword.addEventListener('click', function() {
        togglePasswordVisibility('register-password', this);
      });

      toggleConfirmPassword.addEventListener('click', function() {
        togglePasswordVisibility('confirm-password', this);
      });

      // Chat buttons
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendText();
        }
      });
      sendTextBtn.addEventListener('click', sendText);
      sendImageBtn.addEventListener('click', uploadImage);
      uploadInput.addEventListener('change', handleImageUpload);
      removeImageBtn.addEventListener('click', removeImage);

      // Friend buttons
      addFriendBtn.addEventListener('click', () => {
        addFriendModal.classList.add('active');
      });
      closeAddFriend.addEventListener('click', () => {
        addFriendModal.classList.remove('active');
      });
      sendRequestBtn.addEventListener('click', sendFriendRequest);
      friendRequestsBtn.addEventListener('click', () => {
        requestsModal.classList.add('active');
        loadFriendRequests();
      });
      closeRequests.addEventListener('click', () => {
        requestsModal.classList.remove('active');
      });

      // Group buttons
      createGroupBtn.addEventListener('click', () => {
        createGroupModal.classList.add('active');
        loadFriendsForGroup();
      });
      closeCreateGroup.addEventListener('click', () => {
        createGroupModal.classList.remove('active');
      });
      createGroupConfirmBtn.addEventListener('click', createGroup);
      addFriendsToGroupBtn.addEventListener('click', () => {
        addFriendsToGroupModal.classList.add('active');
        loadFriendsToAddToGroup();
      });
      closeAddFriendsToGroup.addEventListener('click', () => {
        addFriendsToGroupModal.classList.remove('active');
      });
      addFriendsToGroupConfirmBtn.addEventListener('click', addFriendsToGroup);
      leaveGroupBtn.addEventListener('click', leaveGroup);
      kickMemberBtn.addEventListener('click', kickMember);

      // Settings buttons
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
      });
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('active');
      });
      saveSettingsBtn.addEventListener('click', saveSettings);

      // Profile buttons
      profileEditBtn.addEventListener('click', () => {
        profileView.style.display = 'none';
        profileEditForm.style.display = 'flex';
      });
      cancelProfileEditBtn.addEventListener('click', () => {
        profileView.style.display = 'flex';
        profileEditForm.style.display = 'none';
      });
      saveProfileBtn.addEventListener('click', saveProfile);
      profilePictureUpload.addEventListener('change', handleProfilePictureUpload);
      closeProfileView.addEventListener('click', () => {
        profileViewModal.classList.remove('active');
      });

      // Background options
      document.querySelectorAll('.bg-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.bg-option').forEach(opt => {
            opt.classList.remove('active');
          });
          option.classList.add('active');
        });
      });
    }

    // Toggle password visibility
    function togglePasswordVisibility(inputId, icon) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // Set up textarea auto-resize
    function setupTextareaAutoResize() {
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }

    // Show status message
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = `status ${type}`;
      
      if (type !== 'loading') {
        setTimeout(() => {
          element.textContent = '';
          element.className = 'status';
        }, 3000);
      }
    }

    // Format timestamp
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Register new user with Firebase
    async function registerUser() {
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value.trim();
      const confirmPassword = document.getElementById('confirm-password').value.trim();

      // Validation
      if (!username || !password || !confirmPassword) {
        showStatus(registerStatus, 'All fields are required', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showStatus(registerStatus, 'Passwords do not match', 'error');
        return;
      }

      if (password.length < 6) {
        showStatus(registerStatus, 'Password must be at least 6 characters', 'error');
        return;
      }

      showStatus(registerStatus, 'Creating account...', 'loading');
      registerBtn.disabled = true;

      try {
        // Check if username already exists
        const snapshot = await db.ref(`users/${username}`).once('value');
        if (snapshot.exists()) {
          throw new Error('Username already exists');
        }
        
        // Create user in database
        await db.ref(`users/${username}`).set({
          username,
          password, // Note: In production, you should hash passwords
          createdAt: Date.now(),
          friends: [],
          friendRequests: [],
          groups: [],
          profile: {
            description: '',
            avatarUrl: ''
          },
          lastSeen: Date.now()
        });

        showStatus(registerStatus, 'Account created successfully!', 'success');
        
        // Clear form
        document.getElementById('register-username').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('confirm-password').value = '';
        
        // Switch to login tab
        setTimeout(() => {
          loginTab.click();
        }, 1500);
      } catch (error) {
        console.error('Registration error:', error);
        showStatus(registerStatus, `Error: ${error.message}`, 'error');
      } finally {
        registerBtn.disabled = false;
      }
    }

    // Login user with Firebase
    async function loginUser() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();

      if (!username || !password) {
        showStatus(loginStatus, 'Username and password are required', 'error');
        return;
      }

      showStatus(loginStatus, 'Signing in...', 'loading');
      loginBtn.disabled = true;

      try {
        // Get user from Firebase
        const snapshot = await db.ref(`users/${username}`).once('value');
        const user = snapshot.val();
        
        if (!user || user.password !== password) {
          throw new Error('Invalid username or password');
        }

        currentUser = {
          uid: user.username,
          username: user.username,
          friends: user.friends || [],
          friendRequests: user.friendRequests || [],
          groups: user.groups || [],
          profile: user.profile || { description: '', avatarUrl: '' }
        };

        // Save to localStorage for persistent login
        localStorage.setItem('currentUser', JSON.stringify({
          username: currentUser.username,
          password: password, // Note: In production, use a more secure method
          lastLogin: Date.now()
        }));

        // Update UI
        profileName.textContent = currentUser.username;
        profileAvatarText.textContent = currentUser.username.charAt(0).toUpperCase();
        
        // Load profile picture if exists
        if (currentUser.profile.avatarUrl) {
          profileAvatarImg.src = currentUser.profile.avatarUrl;
          profileAvatarImg.style.display = 'block';
          profileAvatarText.style.display = 'none';
        } else {
          profileAvatarImg.style.display = 'none';
          profileAvatarText.style.display = 'block';
        }
        
        // Load profile description
        if (currentUser.profile.description) {
          profileDescription.textContent = currentUser.profile.description;
        }

        showStatus(loginStatus, 'Login successful!', 'success');
        
        // Switch to chat interface
        setTimeout(() => {
          authContainer.style.display = 'none';
          appContainer.style.display = 'flex';
          messageInput.focus();
          loadFriends();
          loadFriendRequests();
          loadGroups();
          
          // Set up real-time friend request listener
          db.ref(`users/${currentUser.username}/friendRequests`).on('value', (snapshot) => {
            const requests = snapshot.val() || [];
            pendingRequests = requests;
            updateRequestBadge();
          });
        }, 1000);
      } catch (error) {
        console.error('Login error:', error);
        showStatus(loginStatus, `Error: ${error.message}`, 'error');
      } finally {
        loginBtn.disabled = false;
      }
    }

    // Logout user
    function logoutUser() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      authContainer.style.display = 'flex';
      appContainer.style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      messagesContainer.innerHTML = '';
      friendsList.innerHTML = `
        <div class="friend-item" id="add-friend-btn">
          <div class="friend-avatar"><i class="fas fa-user-plus"></i></div>
          <div class="friend-name">Add Friend</div>
        </div>
        <div class="friend-item" id="friend-requests-btn">
          <div class="friend-avatar"><i class="fas fa-user-clock"></i></div>
          <div class="friend-name">Friend Requests</div>
          <div id="request-badge" class="request-badge" style="display: none;"></div>
        </div>
        <div class="friend-item" id="create-group-btn">
          <div class="friend-avatar"><i class="fas fa-users"></i></div>
          <div class="friend-name">Create Group</div>
        </div>
      `;
      // Re-add event listeners
      document.getElementById('add-friend-btn').addEventListener('click', () => {
        addFriendModal.classList.add('active');
      });
      document.getElementById('friend-requests-btn').addEventListener('click', () => {
        requestsModal.classList.add('active');
      });
      document.getElementById('create-group-btn').addEventListener('click', () => {
        createGroupModal.classList.add('active');
      });
    }

    // Check if user is already logged in
    function checkAuth() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        const { username, password } = JSON.parse(savedUser);
        document.getElementById('login-username').value = username;
        document.getElementById('login-password').value = password;
        loginBtn.click();
      } else {
        authContainer.style.display = 'flex';
        appContainer.style.display = 'none';
      }
    }

    // Load friends for the current user
    async function loadFriends() {
      try {
        // Clear existing friends
        friends = [];
        const friendsListItems = document.querySelectorAll('.friend-item:not(#add-friend-btn):not(#friend-requests-btn):not(#create-group-btn)');
        friendsListItems.forEach(item => item.remove());
        
        // Add each friend to the list
        for (const friendUsername of currentUser.friends) {
          const snapshot = await db.ref(`users/${friendUsername}`).once('value');
          const friend = snapshot.val();
          
          if (friend) {
            friends.push({
              username: friend.username,
              status: 'online', // Simplified - in a real app you'd track this properly
              lastActivity: chatActivity[friend.username] || 0
            });
            
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            friendItem.dataset.username = friend.username;
            friendItem.innerHTML = `
              <div class="friend-avatar">${friend.username.charAt(0).toUpperCase()}</div>
              <div class="friend-name">${friend.username}</div>
              <div class="friend-status status-online"></div>
            `;
            
            friendItem.addEventListener('click', () => {
              openChat(friend.username, 'friend');
            });
            
            friendsList.appendChild(friendItem);
          }
        }
        
        // Sort friends by last activity (most recent first)
        sortFriendsList();
      } catch (error) {
        console.error('Error loading friends:', error);
      }
    }

    // Sort friends list by most recent activity
    function sortFriendsList() {
      const container = document.getElementById('friends-list');
      const items = Array.from(document.querySelectorAll('.friend-item[data-username], .friend-item[data-group]'));
      
      // Sort items by last activity
      items.sort((a, b) => {
        const aActivity = chatActivity[a.dataset.username || a.dataset.group] || 0;
        const bActivity = chatActivity[b.dataset.username || b.dataset.group] || 0;
        return bActivity - aActivity;
      });
      
      // Re-add items in sorted order (after the first 3 fixed items)
      const fixedItems = Array.from(container.children).slice(0, 3);
      items.forEach(item => container.appendChild(item));
    }

    // Load friends for group creation
    async function loadFriendsForGroup() {
      try {
        friendsToAdd.innerHTML = '';
        
        for (const friendUsername of currentUser.friends) {
          const friendCheckbox = document.createElement('div');
          friendCheckbox.className = 'friend-checkbox';
          friendCheckbox.innerHTML = `
            <input type="checkbox" id="friend-${friendUsername}" value="${friendUsername}">
            <label for="friend-${friendUsername}">${friendUsername}</label>
          `;
          friendsToAdd.appendChild(friendCheckbox);
        }
      } catch (error) {
        console.error('Error loading friends for group:', error);
      }
    }

    // Load friends to add to existing group
    async function loadFriendsToAddToGroup() {
      try {
        friendsToAddToGroup.innerHTML = '';
        
        if (!currentChat || currentChat.type !== 'group') return;
        
        // Get current group members
        const groupSnapshot = await db.ref(`groups/${currentChat.id}`).once('value');
        const group = groupSnapshot.val();
        if (!group) return;
        
        const currentMembers = group.members.map(m => m.username);
        
        // Add friends not already in group
        for (const friendUsername of currentUser.friends) {
          if (!currentMembers.includes(friendUsername)) {
            const friendCheckbox = document.createElement('div');
            friendCheckbox.className = 'friend-checkbox';
            friendCheckbox.innerHTML = `
              <input type="checkbox" id="add-to-group-${friendUsername}" value="${friendUsername}">
              <label for="add-to-group-${friendUsername}">${friendUsername}</label>
            `;
            friendsToAddToGroup.appendChild(friendCheckbox);
          }
        }
      } catch (error) {
        console.error('Error loading friends to add to group:', error);
      }
    }

    // Load friend requests
    async function loadFriendRequests() {
      try {
        requestsList.innerHTML = '';
        
        for (const requester of pendingRequests) {
          const requestItem = document.createElement('div');
          requestItem.className = 'request-item';
          requestItem.innerHTML = `
            <div class="friend-info">
              <div class="friend-avatar">${requester.charAt(0).toUpperCase()}</div>
              <div class="friend-name">${requester}</div>
            </div>
            <div class="request-actions">
              <button class="accept-request" data-username="${requester}">
                <i class="fas fa-check"></i> Accept
              </button>
              <button class="reject-request" data-username="${requester}">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          `;
          
          requestsList.appendChild(requestItem);
        }
        
        // Add event listeners to accept/reject buttons
        document.querySelectorAll('.accept-request').forEach(btn => {
          btn.addEventListener('click', () => handleFriendRequest(btn.dataset.username, true));
        });
        
        document.querySelectorAll('.reject-request').forEach(btn => {
          btn.addEventListener('click', () => handleFriendRequest(btn.dataset.username, false));
        });
      } catch (error) {
        console.error('Error loading friend requests:', error);
      }
    }

    // Update request badge
    function updateRequestBadge() {
      if (pendingRequests.length > 0) {
        requestBadge.style.display = 'flex';
        requestBadge.textContent = pendingRequests.length;
      } else {
        requestBadge.style.display = 'none';
      }
    }

    // Load groups for the current user
    async function loadGroups() {
      try {
        // Clear existing groups
        groups = [];
        const groupItems = document.querySelectorAll('.friend-item[data-group]');
        groupItems.forEach(item => item.remove());
        
        // Add each group to the list
        for (const groupId of currentUser.groups) {
          const snapshot = await db.ref(`groups/${groupId}`).once('value');
          const group = snapshot.val();
          
          if (group) {
            groups.push({
              id: groupId,
              name: group.name,
              creator: group.creator,
              members: group.members
            });
            
            const groupItem = document.createElement('div');
            groupItem.className = 'friend-item';
            groupItem.dataset.group = groupId;
            groupItem.innerHTML = `
              <div class="friend-avatar"><i class="fas fa-users"></i></div>
              <div class="friend-name">${group.name}</div>
              <div class="friend-status status-online"></div>
            `;
            
            groupItem.addEventListener('click', () => {
              openChat(groupId, 'group');
            });
            
            friendsList.appendChild(groupItem);
          }
        }
        
        // Sort groups by last activity
        sortFriendsList();
      } catch (error) {
        console.error('Error loading groups:', error);
      }
    }

    // Open a chat (friend or group)
    function openChat(id, type) {
      currentChat = { id, type };
      messagesContainer.innerHTML = '';
      
      if (type === 'friend') {
        chatTitle.textContent = id;
        chatActions.style.display = 'none';
      } else if (type === 'group') {
        const group = groups.find(g => g.id === id);
        if (group) {
          chatTitle.textContent = group.name;
          currentGroupMembers = group.members;
          
          // Only show actions if user is group creator
          if (group.creator === currentUser.username) {
            chatActions.style.display = 'flex';
          } else {
            chatActions.style.display = 'none';
          }
        }
      }
      
      // Load messages
      loadMessages(id, type);
      
      // Update chat activity
      chatActivity[id] = Date.now();
      sortFriendsList();
    }

    // Load messages for a chat
    function loadMessages(id, type) {
      // Clear existing messages
      messagesContainer.innerHTML = '';
      
      // Listen for new messages
      db.ref(`messages/${type}/${id}`).on('child_added', (snapshot) => {
        const msg = snapshot.val();
        const isCurrentUser = msg.userId === currentUser?.username;
        
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
        
        if (msg.type === "text") {
          msgDiv.innerHTML = `
            <div class="message-user-profile">
              <div class="message-user-avatar" data-username="${msg.username}">${msg.username.charAt(0).toUpperCase()}</div>
              <div class="message-username" data-username="${msg.username}">${msg.username} ${msg.username === 'Yug' ? '<span class="owner-badge">OWNER</span>' : ''}</div>
            </div>
            <div class="text">${msg.text}</div>
            <div class="timestamp">${formatTime(msg.time)}</div>
          `;
        } else if (msg.type === "image") {
          msgDiv.innerHTML = `
            <div class="message-user-profile">
              <div class="message-user-avatar" data-username="${msg.username}">${msg.username.charAt(0).toUpperCase()}</div>
              <div class="message-username" data-username="${msg.username}">${msg.username} ${msg.username === 'Yug' ? '<span class="owner-badge">OWNER</span>' : ''}</div>
            </div>
            <div class="image-container">
              <img src="${msg.url}" alt="Sent image">
            </div>
            <div class="timestamp">${formatTime(msg.time)}</div>
          `;
        }
        
        messagesContainer.appendChild(msgDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Add click event to profile elements
        document.querySelectorAll(`[data-username="${msg.username}"]`).forEach(el => {
          el.addEventListener('click', () => viewUserProfile(msg.username));
        });
      });
    }

    // Send text message
    function sendText() {
      const text = messageInput.value.trim();
      if (!text && !selectedImage) {
        showStatus(chatStatus, 'Message cannot be empty', 'error');
        return;
      }

      if (!currentUser || !currentChat) {
        showStatus(chatStatus, 'You need to open a chat first', 'error');
        return;
      }

      if (selectedImage) {
        uploadImage();
        return;
      }

      db.ref(`messages/${currentChat.type}/${currentChat.id}`).push({
        type: "text",
        text: text,
        time: Date.now(),
        username: currentUser.username,
        userId: currentUser.username
      });
      
      // Update chat activity
      chatActivity[currentChat.id] = Date.now();
      sortFriendsList();
      
      messageInput.value = '';
      messageInput.style.height = 'auto';
      messageInput.focus();
    }

    // Handle image upload selection
    function handleImageUpload() {
      const file = uploadInput.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.match('image.*')) {
        showStatus(chatStatus, 'Only images are allowed', 'error');
        uploadInput.value = '';
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showStatus(chatStatus, 'Image must be smaller than 5MB', 'error');
        uploadInput.value = '';
        return;
      }

      selectedImage = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.classList.add('visible');
        removeImageBtn.style.display = 'block';
        sendImageBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // Remove selected image
    function removeImage() {
      selectedImage = null;
      imagePreview.src = '';
      imagePreview.classList.remove('visible');
      removeImageBtn.style.display = 'none';
      uploadInput.value = '';
      sendImageBtn.disabled = true;
    }

    // Upload and send image
    async function uploadImage() {
      if (!selectedImage) {
        showStatus(chatStatus, 'Please select an image first', 'error');
        return;
      }

      if (!currentUser || !currentChat) {
        showStatus(chatStatus, 'You need to open a chat first', 'error');
        return;
      }

      sendImageBtn.disabled = true;
      showStatus(chatStatus, 'Uploading image...', 'loading');

      try {
        const formData = new FormData();
        formData.append("image", selectedImage);
        
        const res = await fetch("https://api.imgbb.com/1/upload?key=2d802312c23a6e0a1586772e069f1767", {
          method: "POST",
          body: formData
        });
        
        const data = await res.json();
        
        if (!data.success) {
          throw new Error(data.error.message || 'Image upload failed');
        }
        
        const imageUrl = data.data.url;
        
        db.ref(`messages/${currentChat.type}/${currentChat.id}`).push({
          type: "image",
          url: imageUrl,
          time: Date.now(),
          username: currentUser.username,
          userId: currentUser.username
        });
        
        // Update chat activity
        chatActivity[currentChat.id] = Date.now();
        sortFriendsList();
        
        showStatus(chatStatus, 'Image sent successfully', 'success');
        removeImage();
      } catch (error) {
        console.error('Upload error:', error);
        showStatus(chatStatus, `Error: ${error.message}`, 'error');
      } finally {
        sendImageBtn.disabled = false;
      }
    }

    // Send friend request
    async function sendFriendRequest() {
      const username = friendUsernameInput.value.trim();

      if (!username) {
        showStatus(friendStatus, 'Username is required', 'error');
        return;
      }

      if (username === currentUser.username) {
        showStatus(friendStatus, 'You cannot add yourself', 'error');
        return;
      }

      showStatus(friendStatus, 'Sending request...', 'loading');
      sendRequestBtn.disabled = true;

      try {
        // Check if user exists
        const snapshot = await db.ref(`users/${username}`).once('value');
        const targetUser = snapshot.val();
        
        if (!targetUser) {
          throw new Error('User not found');
        }
        
        // Check if already friends
        if (currentUser.friends.includes(username)) {
          throw new Error('Already friends with this user');
        }
        
        // Check if request already sent
        if (targetUser.friendRequests && targetUser.friendRequests.includes(currentUser.username)) {
          throw new Error('Request already sent');
        }
        
        // Add request to target user's friendRequests array
        await db.ref(`users/${username}/friendRequests`).transaction((requests) => {
          requests = requests || [];
          if (!requests.includes(currentUser.username)) {
            requests.push(currentUser.username);
          }
          return requests;
        });

        showStatus(friendStatus, 'Friend request sent!', 'success');
        friendUsernameInput.value = '';
        
        // Close modal
        setTimeout(() => {
          addFriendModal.classList.remove('active');
        }, 1500);
      } catch (error) {
        console.error('Friend request error:', error);
        showStatus(friendStatus, `Error: ${error.message}`, 'error');
      } finally {
        sendRequestBtn.disabled = false;
      }
    }

    // Handle friend request (accept/reject)
    async function handleFriendRequest(requester, accept) {
      try {
        showStatus(requestsStatus, 'Processing request...', 'loading');
        
        // Remove request from current user's friendRequests
        await db.ref(`users/${currentUser.username}/friendRequests`).transaction((requests) => {
          requests = requests || [];
          return requests.filter(r => r !== requester);
        });
        
        if (accept) {
          // Add each other as friends
          await db.ref(`users/${currentUser.username}/friends`).transaction((friends) => {
            friends = friends || [];
            if (!friends.includes(requester)) {
              friends.push(requester);
            }
            return friends;
          });
          
          await db.ref(`users/${requester}/friends`).transaction((friends) => {
            friends = friends || [];
            if (!friends.includes(currentUser.username)) {
              friends.push(currentUser.username);
            }
            return friends;
          });
          
          // Update current user's friends list
          if (!currentUser.friends.includes(requester)) {
            currentUser.friends.push(requester);
          }
          
          showStatus(requestsStatus, 'Friend request accepted!', 'success');
          
          // Reload friends list and open chat with new friend
          await loadFriends();
          openChat(requester, 'friend');
        } else {
          showStatus(requestsStatus, 'Friend request rejected', 'success');
        }
        
        // Update pending requests
        pendingRequests = pendingRequests.filter(r => r !== requester);
        updateRequestBadge();
        
        // Reload requests list
        loadFriendRequests();
      } catch (error) {
        console.error('Error handling friend request:', error);
        showStatus(requestsStatus, `Error: ${error.message}`, 'error');
      }
    }

    // Create a new group chat
    async function createGroup() {
      const name = groupNameInput.value.trim();
      
      if (!name) {
        showStatus(groupStatus, 'Group name is required', 'error');
        return;
      }

      showStatus(groupStatus, 'Creating group...', 'loading');
      createGroupConfirmBtn.disabled = true;

      try {
        // Get selected members
        const selectedMembers = Array.from(document.querySelectorAll('#friends-to-add input:checked'))
          .map(input => input.value);
        
        // Create group object
        const groupId = 'group-' + Date.now();
        const newGroup = {
          id: groupId,
          name,
          creator: currentUser.username,
          members: [
            { username: currentUser.username, role: 'creator' },
            ...selectedMembers.map(username => ({ username, role: 'member' }))
          ],
          createdAt: Date.now()
        };
        
        // Add group to database
        await db.ref(`groups/${groupId}`).set(newGroup);
        
        // Add group to each member's groups array
        const updates = {};
        newGroup.members.forEach(member => {
          updates[`users/${member.username}/groups/${groupId}`] = true;
        });
        await db.ref().update(updates);

        // Update current user's groups
        if (!currentUser.groups.includes(groupId)) {
          currentUser.groups.push(groupId);
        }

        showStatus(groupStatus, 'Group created successfully!', 'success');
        
        // Clear form
        groupNameInput.value = '';
        document.querySelectorAll('#friends-to-add input').forEach(input => {
          input.checked = false;
        });
        
        // Close modal and reload groups
        setTimeout(() => {
          createGroupModal.classList.remove('active');
          loadGroups();
          openChat(groupId, 'group');
        }, 1500);
      } catch (error) {
        console.error('Group creation error:', error);
        showStatus(groupStatus, `Error: ${error.message}`, 'error');
      } finally {
        createGroupConfirmBtn.disabled = false;
      }
    }

    // Add friends to existing group
    async function addFriendsToGroup() {
      if (!currentChat || currentChat.type !== 'group') {
        showStatus(addFriendsStatus, 'Not in a group chat', 'error');
        return;
      }

      showStatus(addFriendsStatus, 'Adding friends...', 'loading');
      addFriendsToGroupConfirmBtn.disabled = true;

      try {
        // Get selected members
        const selectedMembers = Array.from(document.querySelectorAll('#friends-to-add-to-group input:checked'))
          .map(input => input.value);
        
        if (selectedMembers.length === 0) {
          throw new Error('No friends selected');
        }
        
        // Get current group
        const groupSnapshot = await db.ref(`groups/${currentChat.id}`).once('value');
        const group = groupSnapshot.val();
        
        if (!group) {
          throw new Error('Group not found');
        }
        
        // Add new members to group
        const updatedMembers = [...group.members];
        for (const username of selectedMembers) {
          if (!updatedMembers.some(m => m.username === username)) {
            updatedMembers.push({ username, role: 'member' });
          }
        }
        
        // Update group in database
        await db.ref(`groups/${currentChat.id}/members`).set(updatedMembers);
        
        // Add group to each new member's groups array
        const updates = {};
        selectedMembers.forEach(username => {
          updates[`users/${username}/groups/${currentChat.id}`] = true;
        });
        await db.ref().update(updates);

        showStatus(addFriendsStatus, 'Friends added to group!', 'success');
        
        // Clear selections
        document.querySelectorAll('#friends-to-add-to-group input').forEach(input => {
          input.checked = false;
        });
        
        // Close modal and reload group info
        setTimeout(() => {
          addFriendsToGroupModal.classList.remove('active');
          loadGroups();
          openChat(currentChat.id, 'group');
        }, 1500);
      } catch (error) {
        console.error('Error adding friends to group:', error);
        showStatus(addFriendsStatus, `Error: ${error.message}`, 'error');
      } finally {
        addFriendsToGroupConfirmBtn.disabled = false;
      }
    }

    // Leave a group
    async function leaveGroup() {
      if (!currentChat || currentChat.type !== 'group') {
        showStatus(chatStatus, 'Not in a group chat', 'error');
        return;
      }

      if (confirm('Are you sure you want to leave this group?')) {
        showStatus(chatStatus, 'Leaving group...', 'loading');
        
        try {
          // Get group info
          const groupSnapshot = await db.ref(`groups/${currentChat.id}`).once('value');
          const group = groupSnapshot.val();
          
          if (!group) {
            throw new Error('Group not found');
          }
          
          // Remove user from group members
          const updatedMembers = group.members.filter(m => m.username !== currentUser.username);
          
          // If no members left, delete the group
          if (updatedMembers.length === 0) {
            await db.ref(`groups/${currentChat.id}`).remove();
          } else {
            await db.ref(`groups/${currentChat.id}/members`).set(updatedMembers);
          }
          
          // Remove group from user's groups list
          await db.ref(`users/${currentUser.username}/groups/${currentChat.id}`).remove();

          // Update current user's groups
          currentUser.groups = currentUser.groups.filter(g => g !== currentChat.id);

          showStatus(chatStatus, 'You have left the group', 'success');
          
          // Close the chat
          currentChat = null;
          messagesContainer.innerHTML = '';
          chatTitle.textContent = 'Direct Messages';
          chatActions.style.display = 'none';
          
          // Reload groups
          loadGroups();
        } catch (error) {
          console.error('Leave group error:', error);
          showStatus(chatStatus, `Error: ${error.message}`, 'error');
        }
      }
    }

    // Kick a member from group
    async function kickMember() {
      if (!currentChat || currentChat.type !== 'group' || !currentGroupMembers) {
        showStatus(chatStatus, 'Not in a group chat', 'error');
        return;
      }

      // Show list of members to kick (excluding self)
      const membersToKick = currentGroupMembers
        .filter(m => m.username !== currentUser.username)
        .map(m => m.username);
      
      if (membersToKick.length === 0) {
        showStatus(chatStatus, 'No members to kick', 'error');
        return;
      }

      const memberToKick = prompt(`Enter username to kick:\n${membersToKick.join('\n')}`);
      if (!memberToKick || !membersToKick.includes(memberToKick)) {
        return;
      }

      if (confirm(`Are you sure you want to kick ${memberToKick} from the group?`)) {
        showStatus(chatStatus, 'Kicking member...', 'loading');
        
        try {
          // Get group info
          const groupSnapshot = await db.ref(`groups/${currentChat.id}`).once('value');
          const group = groupSnapshot.val();
          
          if (!group) {
            throw new Error('Group not found');
          }
          
          // Remove member from group
          const updatedMembers = group.members.filter(m => m.username !== memberToKick);
          await db.ref(`groups/${currentChat.id}/members`).set(updatedMembers);
          
          // Remove group from kicked user's groups list
          await db.ref(`users/${memberToKick}/groups/${currentChat.id}`).remove();

          showStatus(chatStatus, `${memberToKick} has been kicked from the group`, 'success');
          
          // Reload group info
          const updatedGroupSnapshot = await db.ref(`groups/${currentChat.id}`).once('value');
          const updatedGroup = updatedGroupSnapshot.val();
          if (updatedGroup) {
            currentGroupMembers = updatedGroup.members;
          }
        } catch (error) {
          console.error('Kick member error:', error);
          showStatus(chatStatus, `Error: ${error.message}`, 'error');
        }
      }
    }

    // Save settings
    function saveSettings() {
      const selectedBg = document.querySelector('.bg-option.active').dataset.bg;
      
      // Apply background
      if (selectedBg === 'default') {
        document.body.style.background = 'var(--bg-dark)';
        document.body.style.backgroundImage = 'radial-gradient(circle at 10% 20%, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.8) 90%)';
        document.body.className = '';
      } else if (selectedBg === 'animated-1') {
        document.body.className = 'animated-bg-1';
        document.body.style.background = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'animated-2') {
        document.body.className = 'animated-bg-2';
        document.body.style.background = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'gradient-purple') {
        document.body.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'gradient-blue') {
        document.body.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'gradient-red') {
        document.body.style.background = 'linear-gradient(135deg, #ef4444, #b91c1c)';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'gradient-green') {
        document.body.style.background = 'linear-gradient(135deg, #10b981, #047857)';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'gradient-orange') {
        document.body.style.background = 'linear-gradient(135deg, #f59e0b, #b45309)';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'black') {
        document.body.style.background = '#000';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      } else if (selectedBg === 'white') {
        document.body.style.background = '#fff';
        document.body.className = '';
        document.body.style.backgroundImage = '';
      }
      
      showStatus(settingsStatus, 'Settings saved!', 'success');
      setTimeout(() => {
        settingsModal.classList.remove('active');
      }, 1500);
    }

    // Handle profile picture upload
    function handleProfilePictureUpload() {
      const file = profilePictureUpload.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.match('image.*')) {
        showStatus(settingsStatus, 'Only images are allowed', 'error');
        profilePictureUpload.value = '';
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showStatus(settingsStatus, 'Image must be smaller than 5MB', 'error');
        profilePictureUpload.value = '';
        return;
      }

      profilePictureFile = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        profileAvatarImg.src = e.target.result;
        profileAvatarImg.style.display = 'block';
        profileAvatarText.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    // Save profile changes
    async function saveProfile() {
      showStatus(settingsStatus, 'Saving profile...', 'loading');
      saveProfileBtn.disabled = true;

      try {
        const updates = {
          'profile/description': profileDescriptionInput.value
        };

        if (profilePictureFile) {
          // Upload new profile picture
          const formData = new FormData();
          formData.append("image", profilePictureFile);
          
          const res = await fetch("https://api.imgbb.com/1/upload?key=2d802312c23a6e0a1586772e069f1767", {
            method: "POST",
            body: formData
          });
          
          const data = await res.json();
          
          if (!data.success) {
            throw new Error(data.error.message || 'Profile picture upload failed');
          }
          
          updates['profile/avatarUrl'] = data.data.url;
        }

        // Update profile in database
        await db.ref(`users/${currentUser.username}`).update(updates);

        // Update local user data
        currentUser.profile.description = profileDescriptionInput.value;
        if (profilePictureFile) {
          currentUser.profile.avatarUrl = updates['profile/avatarUrl'];
        }

        // Update UI
        profileDescription.textContent = profileDescriptionInput.value;
        if (profilePictureFile) {
          profileAvatarImg.src = currentUser.profile.avatarUrl;
          profileAvatarImg.style.display = 'block';
          profileAvatarText.style.display = 'none';
        }

        showStatus(settingsStatus, 'Profile saved!', 'success');
        
        // Switch back to view mode
        profileView.style.display = 'flex';
        profileEditForm.style.display = 'none';
        profilePictureFile = null;
        profilePictureUpload.value = '';
      } catch (error) {
        console.error('Profile save error:', error);
        showStatus(settingsStatus, `Error: ${error.message}`, 'error');
      } finally {
        saveProfileBtn.disabled = false;
      }
    }

    // View user profile
    async function viewUserProfile(username) {
      try {
        // If viewing own profile, show edit form
        if (username === currentUser.username) {
          profileView.style.display = 'none';
          profileEditForm.style.display = 'flex';
          profileDescriptionInput.value = currentUser.profile.description || '';
          return;
        }

        // Otherwise show profile modal
        const snapshot = await db.ref(`users/${username}`).once('value');
        const user = snapshot.val();
        
        if (!user) {
          throw new Error('User not found');
        }

        profileModalTitle.textContent = `${username}'s Profile`;
        profileModalName.textContent = username;
        profileModalDescription.textContent = user.profile?.description || 'No description yet';
        
        // Set avatar
        profileModalAvatarText.textContent = username.charAt(0).toUpperCase();
        if (user.profile?.avatarUrl) {
          profileModalAvatarImg.src = user.profile.avatarUrl;
          profileModalAvatarImg.style.display = 'block';
          profileModalAvatarText.style.display = 'none';
        } else {
          profileModalAvatarImg.style.display = 'none';
          profileModalAvatarText.style.display = 'block';
        }

        profileViewModal.classList.add('active');
      } catch (error) {
        console.error('Error viewing profile:', error);
        showStatus(chatStatus, `Error: ${error.message}`, 'error');
      }
    }

    // Initialize the app
    init();
  </script>
</body>
</html>
