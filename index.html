<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Business Empire Clicker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0d0d0d;
      --bg-darker: #050505;
      --card-bg: #1a1a1a;
      --card-hover: #262626;
      --primary: #7c3aed;
      --primary-light: #8b5cf6;
      --accent: #10b981;
      --accent-light: #34d399;
      --text: #f3f4f6;
      --text-secondary: #d1d5db;
      --danger: #ef4444;
      --warning: #f59e0b;
      --disabled: #4b5563;
      --border: #2a2a2a;
      --gold: #ffd700;
      --silver: #c0c0c0;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      line-height: 1.6;
      touch-action: manipulation;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      position: relative;
      padding-bottom: 2rem;
    }
    
    header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-top: 1rem;
    }
    
    h1 {
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 0.5rem;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      letter-spacing: -0.05em;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    h2 {
      font-size: 1.25rem;
      margin: 1.5rem 0 1rem;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card-bg);
      padding: 1.25rem;
      border-radius: 16px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      width: 100%;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    
    .stats::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }
    
    .coins-display {
      font-size: clamp(1.5rem, 5vw, 2rem);
      font-weight: bold;
      color: var(--accent-light);
      letter-spacing: -0.05em;
    }
    
    .cps-display {
      color: var(--text-secondary);
      font-size: clamp(0.8rem, 3vw, 1rem);
      margin-top: 0.25rem;
    }
    
    .click-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
      width: 100%;
      position: relative;
    }
    
    .click-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1.25rem;
      font-size: clamp(1rem, 4vw, 1.2rem);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 4px 16px rgba(124, 58, 237, 0.4);
      font-weight: 600;
      border: 2px solid var(--primary-light);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    .click-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, 
        rgba(255,255,255,0.1) 0%, 
        rgba(255,255,255,0.05) 50%, 
        rgba(255,255,255,0.1) 100%);
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .click-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
    }
    
    .click-btn:hover::before {
      opacity: 1;
    }
    
    .click-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }
    
    .hint {
      color: var(--text-secondary);
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      text-align: center;
      opacity: 0.8;
    }
    
    .upgrades-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
      width: 100%;
    }
    
    .upgrade {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.2s ease;
      border-left: 4px solid var(--primary);
      font-size: clamp(0.8rem, 3vw, 1rem);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .upgrade::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, 
        rgba(16, 185, 129, 0.05) 0%, 
        rgba(16, 185, 129, 0.02) 50%, 
        rgba(16, 185, 129, 0.05) 100%);
      z-index: 0;
    }
    
    .upgrade.unlocked {
      cursor: pointer;
    }
    
    .upgrade.unlocked:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      background: var(--card-hover);
    }
    
    .upgrade.locked {
      opacity: 0.6;
      border-left-color: var(--disabled);
    }
    
    .upgrade-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--accent-light);
      font-size: clamp(0.9rem, 3vw, 1rem);
      position: relative;
      z-index: 1;
    }
    
    .upgrade-desc {
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
      flex-grow: 1;
      position: relative;
      z-index: 1;
    }
    
    .upgrade-cost {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
    }
    
    .upgrade-owned {
      color: var(--text);
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      align-self: flex-end;
      position: relative;
      z-index: 1;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 0.3s ease;
    }
    
    .progress-bar {
      height: 6px;
      background: var(--disabled);
      border-radius: 3px;
      margin-top: 0.75rem;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Coin animation */
    .falling-coin {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      z-index: 100;
      animation: coin-fall linear forwards;
    }
    
    @keyframes coin-fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(calc(100vh + 100px)) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Top Buttons */
    .top-buttons {
      position: absolute;
      top: 0.5rem;
      right: 0;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      max-width: 100%;
    }
    
    .top-btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-secondary);
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 24px;
      cursor: pointer;
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      transition: all 0.2s ease;
      margin-bottom: 0.5rem;
      font-weight: 500;
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    
    .top-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--text);
    }
    
    #signOutBtn {
      display: none;
      background: var(--danger);
      color: white;
      border-color: #dc2626;
    }
    
    #adminBtn {
      display: none;
      background: var(--accent);
      color: white;
      border-color: #059669;
    }
    
    /* Google Sign-In Button Customization */
    #g_id_onload {
      display: none;
    }
    
    .g_id_signin {
      border: none !important;
      background: #4285F4 !important;
      color: white !important;
      border-radius: 24px !important;
      height: 38px !important;
      padding: 0 16px !important;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    
    .g_id_signin:hover {
      background: #3367D6 !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* User Profile Display */
    .user-profile {
      display: none;
      align-items: center;
      gap: 8px;
      margin-bottom: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 0.5rem 0.75rem;
      border-radius: 24px;
      border: 1px solid var(--border);
    }
    
    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .username-container {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    
    .username-edit {
      width: 14px;
      height: 14px;
      opacity: 0.6;
      transition: all 0.2s;
      fill: var(--text-secondary);
    }
    
    .username-container:hover .username-edit {
      opacity: 1;
      fill: var(--text);
    }
    
    .user-name {
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      color: var(--text);
      font-weight: 500;
    }
    
    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .modal-content {
      background: var(--card-bg);
      padding: 1.75rem;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      animation: modalSlideUp 0.3s ease;
    }
    
    @keyframes modalSlideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .close-modal {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      transition: all 0.2s;
    }
    
    .close-modal:hover {
      color: var(--text);
      transform: rotate(90deg);
    }
    
    .modal-title {
      font-size: clamp(1.2rem, 5vw, 1.5rem);
      color: var(--accent-light);
      margin-bottom: 1.5rem;
      font-weight: 600;
    }
    
    /* Click Upgrades Modal */
    .click-upgrades-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    
    .click-upgrade {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      padding: 1rem;
      border-left: 4px solid var(--primary);
      transition: all 0.2s ease;
      font-size: clamp(0.8rem, 3vw, 1rem);
      border: 1px solid var(--border);
    }
    
    .click-upgrade.unlocked {
      cursor: pointer;
    }
    
    .click-upgrade.unlocked:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      background: var(--card-hover);
    }
    
    .click-upgrade.locked {
      opacity: 0.6;
      border-left-color: var(--disabled);
    }
    
    .click-upgrade-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--accent-light);
      font-size: clamp(0.9rem, 3vw, 1rem);
    }
    
    .click-upgrade-desc {
      font-size: clamp(0.7rem, 3vw, 0.8rem);
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
    }
    
    .click-upgrade-cost {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: clamp(0.7rem, 3vw, 0.9rem);
    }
    
    .click-upgrade-owned {
      color: var(--text);
      font-size: clamp(0.7rem, 3vw, 0.8rem);
      font-style: italic;
      margin-top: 0.5rem;
    }
    
    /* Code Modal */
    .code-input {
      width: 100%;
      padding: 1rem;
      margin: 1.5rem 0;
      background: var(--bg-darker);
      border: 1px solid var(--primary);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .code-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    
    .submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
      width: 100%;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    
    .submit-btn:hover {
      background: var(--primary-light);
    }
    
    .code-message {
      margin-top: 1.5rem;
      color: var(--accent-light);
      font-weight: 600;
      text-align: center;
      font-size: clamp(0.8rem, 3vw, 1rem);
      min-height: 1.5rem;
    }
    
    /* Leaderboard styles */
    .leaderboard-container {
      margin-top: 1rem;
      min-height: 300px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      align-items: center;
      transition: all 0.3s ease;
      font-size: clamp(0.8rem, 3vw, 1rem);
      background: var(--card-bg);
    }
    
    .leaderboard-entry:hover {
      background: var(--card-hover);
    }
    
    .leaderboard-rank {
      width: 24px;
      text-align: center;
      font-weight: bold;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .leaderboard-user {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-grow: 1;
      margin: 0 0.75rem;
      overflow: hidden;
    }
    
    .leaderboard-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .leaderboard-score {
      font-weight: bold;
      color: var(--accent-light);
      min-width: 100px;
      text-align: right;
      flex-shrink: 0;
    }
    
    .leaderboard-rebirths {
      color: var(--primary-light);
      font-weight: bold;
      min-width: 60px;
      text-align: right;
      flex-shrink: 0;
    }
    
    /* Podium positions */
    .leaderboard-entry:nth-child(1) {
      background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent);
      border-left: 4px solid var(--gold);
    }
    
    .leaderboard-entry:nth-child(2) {
      background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent);
      border-left: 4px solid var(--silver);
    }
    
    .leaderboard-entry:nth-child(3) {
      background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent);
      border-left: 4px solid #cd7f32;
    }
    
    /* Loading spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--accent);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    
    /* Tabs */
    .leaderboard-tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .tab-btn {
      background: none;
      border: none;
      padding: 0.5rem 1rem;
      color: var(--text-secondary);
      cursor: pointer;
      position: relative;
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      white-space: nowrap;
      font-weight: 500;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .tab-btn.active {
      color: var(--accent-light);
      background: rgba(16, 185, 129, 0.1);
    }
    
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    
    /* Countdown timer */
    .leaderboard-countdown {
      text-align: center;
      margin-top: 1.5rem;
      color: var(--text-secondary);
      font-size: clamp(0.8rem, 3vw, 1rem);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Admin Panel Styles */
    .admin-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(8px);
      z-index: 4000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    
    .admin-content {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }
    
    .admin-tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
    }
    
    .admin-tab {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: 6px 6px 0 0;
    }
    
    .admin-tab.active {
      border-bottom: 2px solid var(--accent);
      color: var(--accent-light);
      background: rgba(16, 185, 129, 0.1);
    }
    
    #refreshBtn {
      background: var(--warning);
      color: white;
      border: none;
      cursor: pointer;
      margin-left: auto;
      border-radius: 6px;
      padding: 0.75rem 1.25rem;
      transition: all 0.2s;
    }
    
    #refreshBtn:hover {
      background: #e67e22;
    }
    
    .admin-tab-content {
      display: none;
    }
    
    .admin-tab-content.active {
      display: block;
    }
    
    .admin-search {
      width: 100%;
      padding: 0.8rem 1rem;
      margin-bottom: 1.5rem;
      background: var(--bg-darker);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
    }
    
    .admin-user-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg-darker);
    }
    
    .admin-user {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .admin-user:last-child {
      border-bottom: none;
    }
    
    .admin-user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .admin-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .admin-user-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .admin-action-btn {
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      border: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .ban-btn {
      background: var(--danger);
      color: white;
    }
    
    .unban-btn {
      background: var(--accent);
      color: white;
    }
    
    .edit-btn {
      background: var(--primary);
      color: white;
    }
    
    .admin-message-input {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1.5rem;
      background: var(--bg-darker);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      min-height: 120px;
      resize: vertical;
    }
    
    .admin-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      background: var(--bg-darker);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--disabled);
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .admin-status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    
    .success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-light);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Broadcast Message Style */
    .broadcast-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.9);
      color: #ff6b6b;
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      z-index: 5000;
      max-width: 90%;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
      animation: fadeIn 0.3s ease;
      border: 2px solid #ff6b6b;
      backdrop-filter: blur(4px);
    }

    /* Banned User Style */
    .banned-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #ff6b6b;
      font-size: 2rem;
      text-align: center;
      padding: 2rem;
      flex-direction: column;
      backdrop-filter: blur(8px);
    }

    .banned-message h2 {
      color: #ff6b6b;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .banned-message p {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      color: var(--text-secondary);
    }

    .banned-message button {
      margin-top: 2rem;
      padding: 1rem 2rem;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.2rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .banned-message button:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    /* Button loading state */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      border: 3px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: button-loading-spinner 1s ease infinite;
    }
    
    @keyframes button-loading-spinner {
      from { transform: rotate(0turn); }
      to { transform: rotate(1turn); }
    }

    /* Purchase effect */
    @keyframes purchaseEffect {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .purchase-effect {
      animation: purchaseEffect 0.3s ease;
    }

    /* Tutorial Modal */
    .tutorial-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    
    .tutorial-content {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      position: relative;
      border: 1px solid var(--border);
    }
    
    .tutorial-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
    }
    
    .tutorial-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .skip-tutorial {
      background: var(--danger);
      color: white;
      border: none;
    }
    
    .next-tutorial {
      background: var(--accent);
      color: white;
      border: none;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .upgrades-container {
        grid-template-columns: 1fr;
      }
      
      .click-upgrades-grid {
        grid-template-columns: 1fr;
      }
      
      .admin-user {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .admin-user-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
  
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <!-- Google Sign-In Button -->
      <div id="g_id_onload"
           data-client_id="626223048098-078etpvps2clhd02vs3g5h22sa60537g.apps.googleusercontent.com"
           data-callback="handleGoogleSignIn"
           data-context="signin"
           data-ux_mode="popup"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-size="medium"
           data-theme="filled_blue"
           data-text="sign_in_with"
           data-shape="pill"
           data-logo_alignment="left">
      </div>
      
      <!-- User Profile (shown after sign-in) -->
      <div class="user-profile" id="userProfile">
        <img class="user-avatar" id="userAvatar" src="" alt="Profile">
        <div class="username-container" id="usernameContainer">
          <span class="user-name" id="userName"></span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="username-edit">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
          </svg>
        </div>
      </div>
      
      <button class="top-btn" id="upgradeClicksBtn">Upgrade Clicks</button>
      <button class="top-btn" id="codeBtn">Enter Code</button>
      <button class="top-btn" id="leaderboardBtn">Leaderboard</button>
      <button class="top-btn" id="signOutBtn">Sign Out</button>
      <button class="top-btn" id="adminBtn">Admin Panel</button>
    </div>
    
    <header>
      <h1>Business Empire Clicker</h1>
      <p>Build your economic dynasty one click at a time</p>
    </header>
    
    <div class="stats">
      <div>
        <div class="coins-display" id="coins">0</div>
        <div class="cps-display" id="cps">0 coins/sec</div>
      </div>
    </div>
    
    <div class="click-area">
      <button class="click-btn" id="clicker">Earn Coins (1 per click)</button>
      <div class="hint">(Click or press SPACE - no holding!)</div>
    </div>
    
    <h2>Business Upgrades</h2>
    <div class="upgrades-container" id="upgrades"></div>
  </div>

  <!-- Click Upgrades Modal -->
  <div class="modal" id="clickUpgradesModal">
    <div class="modal-content">
      <button class="close-modal" id="closeClickUpgrades">&times;</button>
      <h3 class="modal-title">Click Upgrades</h3>
      <div class="click-upgrades-grid" id="clickUpgradesGrid"></div>
    </div>
  </div>

  <!-- Code Modal -->
  <div class="modal" id="codeModal">
    <div class="modal-content">
      <button class="close-modal" id="closeCodeModal">&times;</button>
      <h3 class="modal-title">Redeem Code</h3>
      <input type="text" class="code-input" id="codeInput" placeholder="Enter code...">
      <button class="submit-btn" id="submitCode">Submit</button>
      <div class="code-message" id="codeMessage"></div>
    </div>
  </div>

  <!-- Username Modal -->
  <div class="modal" id="usernameModal">
    <div class="modal-content">
      <h3 class="modal-title">Choose Your Username</h3>
      <p>Pick a unique display name (3-20 chars, a-z, 0-9, _):</p>
      <input type="text" class="code-input" id="usernameInput" placeholder="Enter username..." maxlength="20">
      <button class="submit-btn" id="saveUsernameBtn">Continue</button>
      <div class="code-message" id="usernameMessage"></div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div class="modal" id="leaderboardModal">
    <div class="modal-content">
      <button class="close-modal" id="closeLeaderboard">&times;</button>
      <h3 class="modal-title">Top Business Tycoons</h3>
      <div class="leaderboard-tabs">
        <button class="tab-btn active" data-tab="combined">Global Leaderboard</button>
      </div>
      <div class="leaderboard-container" id="leaderboardList">
        <div class="loading-spinner"></div>
      </div>
      <div class="leaderboard-countdown" id="leaderboardCountdown"></div>
    </div>
  </div>

  <!-- Admin Panel Modal -->
  <div class="admin-panel" id="adminPanel">
    <div class="admin-content">
      <button class="close-modal" id="closeAdminPanel">&times;</button>
      <h3 class="modal-title">Admin Panel</h3>
      
      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">User Management</div>
        <div class="admin-tab" data-tab="messages">Broadcast Message</div>
        <div class="admin-tab" data-tab="settings">Settings</div>
        <button class="admin-tab" id="refreshBtn">Refresh Game</button>
      </div>
      
      <!-- User Management Tab -->
      <div class="admin-tab-content active" id="usersTab">
        <input type="text" class="admin-search" id="userSearch" placeholder="Search users...">
        <div class="admin-user-list" id="userList">
          <div class="loading-spinner"></div>
        </div>
        <div class="admin-status" id="userStatus"></div>
      </div>
      
      <!-- Broadcast Message Tab -->
      <div class="admin-tab-content" id="messagesTab">
        <textarea class="admin-message-input" id="adminMessage" placeholder="Enter message to broadcast to all players..." rows="4"></textarea>
        <button class="submit-btn" id="sendMessageBtn">Send Message</button>
        <div class="admin-status" id="messageStatus"></div>
      </div>
      
      <!-- Settings Tab -->
      <div class="admin-tab-content" id="settingsTab">
        <div class="admin-toggle">
          <label>Leaderboard Auto-Update:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="leaderboardToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <button class="submit-btn" id="saveSettingsBtn">Save Settings</button>
        <div class="admin-status" id="settingsStatus"></div>
      </div>
    </div>
  </div>

  <!-- Tutorial Modal -->
  <div class="tutorial-modal" id="tutorialModal">
    <div class="tutorial-content">
      <h3 class="modal-title">Welcome to Business Empire Clicker!</h3>
      <p>Click the button to earn coins. Use those coins to buy upgrades that generate coins automatically.</p>
      <p>As you progress, you'll unlock more powerful businesses and upgrades.</p>
      <div class="tutorial-buttons">
        <button class="tutorial-btn skip-tutorial" id="skipTutorial">Skip</button>
        <button class="tutorial-btn next-tutorial" id="nextTutorial">Got It!</button>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // GAME STATE
    // ======================
    let playerName = "Guest";
    let playerUsername = "";
    let playerEmail = "";
    let playerPicture = "";
    let isSignedIn = false;
    let userId = "";
    let rebirthCount = 0;
    let currentTab = 'combined';
    const JSONBIN_BIN_ID = "67e767bc8960c979a57a8524";
    const JSONBIN_API_KEY = "$2a$10$OGaFtpC7qZuCcWqcFuuVoeo5qZL2DTw30lpCqPuQdIDXDCPON1vxu";
    let leaderboardData = [];
    let lastLeaderboardUpdate = 0;
    let leaderboardUpdateInterval = 10 * 60 * 1000; // 10 minutes in ms
    let isAdmin = false;
    let leaderboardAutoUpdate = true;
    let usernameChanges = 0;
    const MAX_USERNAME_CHANGES = 5;
    let lastSave = 0;
    let saveInterval;
    let messageCheckInterval;
    let lastBroadcastCheck = 0;
    let hasSeenTutorial = localStorage.getItem('hasSeenTutorial') === 'true';

    // Game state variables
    let coins = 0;
    let coinsPerClick = 1;
    let coinsPerSecond = 0;
    let spacePressed = false;
    let spaceCooldown = false;
    let highestVisibleUpgrade = 3;
    let rebirthMultiplier = 1;
    
    // Coin images
    const coinImages = [
      "https://github.com/YESSSsj28/TOWER-DEFENSEs/blob/main/pixel-art-game-currency-coin-vector-removebg-preview.png?raw=true",
      "https://github.com/YESSSsj28/TOWER-DEFENSEs/blob/main/pixel-art-illustration-coin-pixelated-coin-coin-pixelated-pixel-art-game-icon-webs_1038602-950__1_-removebg-preview.png?raw=true"
    ];
    
    // Click upgrades data
    const clickUpgrades = [
      { id: 1, name: "+1 Click", amount: 1, cost: 100, purchased: false },
      { id: 2, name: "+5 Clicks", amount: 5, cost: 500, purchased: false },
      { id: 3, name: "+10 Clicks", amount: 10, cost: 1000, purchased: false },
      { id: 4, name: "+100 Clicks", amount: 100, cost: 10000, purchased: false },
      { id: 5, name: "+1K Clicks", amount: 1000, cost: 100000, purchased: false },
      { id: 6, name: "+10K Clicks", amount: 10000, cost: 1000000, purchased: false },
      { id: 7, name: "+100K Clicks", amount: 100000, cost: 10000000, purchased: false },
      { id: 8, name: "+1M Clicks", amount: 1000000, cost: 100000000, purchased: false }
    ];
    
    // Upgrades data (19 upgrades + Death)
    const upgrades = [
      { id: 1, name: "TikTok Shop", baseCost: 10, owned: 0, effect: 0.5, desc: "Basic viral commerce" },
      { id: 2, name: "YouTube Ads", baseCost: 50, owned: 0, effect: 2, desc: "Monetize attention" },
      { id: 3, name: "Instagram Store", baseCost: 100, owned: 0, effect: 3, desc: "Aesthetic capitalism" },
      { id: 4, name: "Dropshipping", baseCost: 200, owned: 0, effect: 5, desc: "Sell what you don't own" },
      { id: 5, name: "Amazon FBA", baseCost: 500, owned: 0, effect: 8, desc: "Warehouse domination" },
      { id: 6, name: "Cryptocurrency", baseCost: 1000, owned: 0, effect: 12, desc: "Digital gold rush" },
      { id: 7, name: "NFT Marketplace", baseCost: 2000, owned: 0, effect: 18, desc: "Tokenize everything" },
      { id: 8, name: "VC Funding", baseCost: 5000, owned: 0, effect: 25, desc: "Other people's money" },
      { id: 9, name: "AI Startup", baseCost: 10000, owned: 0, effect: 35, desc: "Automate the future" },
      { id: 10, name: "Tesla Competitor", baseCost: 20000, owned: 0, effect: 50, desc: "Disrupt transportation" },
      { id: 11, name: "Space Tourism", baseCost: 50000, owned: 0, effect: 75, desc: "The final frontier" },
      { id: 12, name: "Time Travel Tech", baseCost: 100000, owned: 0, effect: 100, desc: "Sell yesterday today" },
      { id: 13, name: "Dyson Sphere", baseCost: 250000, owned: 0, effect: 150, desc: "Harvest a star" },
      { id: 14, name: "Galactic Empire", baseCost: 500000, owned: 0, effect: 225, desc: "Rule the cosmos" },
      { id: 15, name: "Multiverse Corp", baseCost: 1000000, owned: 0, effect: 350, desc: "Infinite markets" },
      { id: 16, name: "Godhood", baseCost: 5000000, owned: 0, effect: 600, desc: "Become divine" },
      { id: 17, name: "Omnipotence", baseCost: 10000000, owned: 0, effect: 1000, desc: "All-powerful" },
      { id: 18, name: "The Singularity", baseCost: 50000000, owned: 0, effect: 2000, desc: "Merge with machines" },
      { id: 19, name: "The Meaning of Life", baseCost: 100000000, owned: 0, effect: 5000, desc: "Ultimate truth" },
      { id: 20, name: "DEATH", baseCost: 1000000000, owned: 0, effect: 0, desc: "Rebirth with 2x power" }
    ];

    // ======================
    // AUTHENTICATION SYSTEM
    // ======================
    function handleGoogleSignIn(response) {
      try {
        const userData = parseJWT(response.credential);
        playerName = userData.name;
        playerEmail = userData.email;
        playerPicture = userData.picture;
        userId = userData.sub;
        isSignedIn = true;
        
        // First check if user is banned
        checkBanStatus().then(isBanned => {
          if (isBanned) {
            showBannedMessage();
            return;
          }
          
          // Check if admin
          if (playerEmail === "yhpatel@lcstudents.com") {
            isAdmin = true;
            document.getElementById('adminBtn').style.display = "block";
          }
          
          // Hide Google sign-in button
          document.querySelector('.g_id_signin').style.display = 'none';
          document.getElementById('signOutBtn').style.display = "block";
          
          // Check if user already has a username
          const savedUser = localStorage.getItem(`user_${userId}`);
          if (savedUser) {
            const user = JSON.parse(savedUser);
            usernameChanges = user.usernameChanges || 0;
            
            // Check if username is still unique
            if (checkUsernameUniqueness(user.username)) {
              playerUsername = user.username;
              updateUserDisplay();
              loadGame();
            } else {
              // Username was taken by someone else, reset it
              localStorage.removeItem(`user_${userId}`);
              showUsernameModal();
            }
          } else {
            showUsernameModal();
          }
          
          // Save basic user info
          localStorage.setItem('googleUser', JSON.stringify({
            name: playerName,
            email: playerEmail,
            picture: playerPicture,
            id: userId
          }));
          
          // Start frequent saving and message checking
          startAutoSave();
          startMessageChecking();
          
          // Show tutorial if first time
          if (!hasSeenTutorial) {
            showTutorial();
          }
        });
      } catch (error) {
        console.error("Error handling Google sign-in:", error);
        alert("There was an error signing in. Please try again.");
      }
    }

    function showTutorial() {
      document.getElementById("tutorialModal").style.display = "flex";
    }

    function closeTutorial() {
      document.getElementById("tutorialModal").style.display = "none";
      localStorage.setItem('hasSeenTutorial', 'true');
      hasSeenTutorial = true;
    }

    async function checkBanStatus() {
      try {
        // First check local storage
        if (localStorage.getItem(`banned_${userId}`)) {
          return true;
        }
        
        // Then check cloud ban list
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const bannedUsers = data.record.bannedUsers || [];
          return bannedUsers.includes(userId);
        }
        return false;
      } catch (error) {
        console.error("Error checking ban status:", error);
        return false;
      }
    }

    function showBannedMessage() {
      // Create banned message overlay
      const bannedEl = document.createElement('div');
      bannedEl.className = 'banned-message';
      bannedEl.innerHTML = `
        <h2>You have been banned!</h2>
        <p>Banned haha -yug.</p>
        <button id="signOutAfterBan">Sign Out</button>
      `;
      document.body.appendChild(bannedEl);
      
      // Add sign out button listener
      document.getElementById('signOutAfterBan').addEventListener('click', signOut);
      
      // Hide all game elements
      document.querySelector('.container').style.display = 'none';
      document.querySelector('.top-buttons').style.display = 'none';
    }

    function checkUsernameUniqueness(username) {
      if (!username) return false;
      const allUsers = JSON.parse(localStorage.getItem('allUsernames') || '{}');
      return !allUsers[username.toLowerCase()] || allUsers[username.toLowerCase()] === userId;
    }

    function showUsernameModal() {
      document.getElementById("usernameModal").style.display = "flex";
      document.getElementById("usernameInput").value = playerName;
      document.getElementById("usernameInput").focus();
    }

    function saveUsername() {
      const usernameInput = document.getElementById("usernameInput");
      const usernameMessage = document.getElementById("usernameMessage");
      
      if (usernameChanges >= MAX_USERNAME_CHANGES) {
        usernameMessage.textContent = `You can only change username ${MAX_USERNAME_CHANGES} times`;
        usernameMessage.style.color = "#ff6b6b";
        return;
      }

      const newUsername = usernameInput.value.trim();
      
      // Validate username
      if (newUsername.length < 3) {
        usernameMessage.textContent = "Username must be at least 3 characters";
        usernameMessage.style.color = "#ff6b6b";
        return;
      }
      
      if (newUsername.length > 20) {
        usernameMessage.textContent = "Username must be 20 characters or less";
        usernameMessage.style.color = "#ff6b6b";
        return;
      }
      
      if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
        usernameMessage.textContent = "Only letters, numbers and underscores allowed";
        usernameMessage.style.color = "#ff6b6b";
        return;
      }
      
      // Check uniqueness
      if (!checkUsernameUniqueness(newUsername)) {
        usernameMessage.textContent = "Username already taken";
        usernameMessage.style.color = "#ff6b6b";
        return;
      }
      
      // Update username tracking
      const allUsers = JSON.parse(localStorage.getItem('allUsernames') || '{}');
      
      // Remove old username if exists
      if (playerUsername) {
        delete allUsers[playerUsername.toLowerCase()];
      }
      
      // Add new username
      playerUsername = newUsername;
      allUsers[newUsername.toLowerCase()] = userId;
      localStorage.setItem('allUsernames', JSON.stringify(allUsers));
      
      // Save user profile
      localStorage.setItem(`user_${userId}`, JSON.stringify({
        username: playerUsername,
        picture: playerPicture,
        usernameChanges: usernameChanges + 1
      }));
      
      usernameChanges++;
      
      // Close modal and update UI
      document.getElementById("usernameModal").style.display = "none";
      updateUserDisplay();
      saveGame(); // Immediate save
    }

    function updateUserDisplay() {
      const userProfile = document.getElementById("userProfile");
      const userAvatar = document.getElementById("userAvatar");
      const userName = document.getElementById("userName");
      
      userProfile.style.display = "flex";
      userAvatar.src = playerPicture;
      userName.textContent = playerUsername;
    }

    function signOut() {
      try {
        // Clear intervals
        clearInterval(saveInterval);
        clearInterval(messageCheckInterval);
        
        google.accounts.id.disableAutoSelect();
        google.accounts.id.revoke(localStorage.getItem('googleUserEmail'), () => {
          console.log('Consent revoked');
        });
        
        isSignedIn = false;
        isAdmin = false;
        playerName = "Guest";
        playerUsername = "";
        userId = "";
        
        document.querySelector('.g_id_signin').style.display = 'block';
        document.getElementById('userProfile').style.display = 'none';
        document.getElementById('signOutBtn').style.display = "none";
        document.getElementById('adminBtn').style.display = "none";
        
        localStorage.removeItem('googleUser');
        
        // Remove banned message if exists
        const bannedEl = document.querySelector('.banned-message');
        if (bannedEl) {
          bannedEl.remove();
        }
        
        // Show game elements again
        document.querySelector('.container').style.display = 'block';
        document.querySelector('.top-buttons').style.display = 'flex';
        
        // Load guest game state
        loadGame();
      } catch (error) {
        console.error("Error signing out:", error);
      }
    }

    function parseJWT(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      return JSON.parse(atob(base64));
    }

    // ======================
    // SAVE SYSTEM
    // ======================
    function startAutoSave() {
      // Clear any existing interval
      if (saveInterval) clearInterval(saveInterval);
      
      // Save every 2 seconds when signed in, every 10 seconds for guests
      const saveFrequency = isSignedIn ? 2000 : 10000;
      saveInterval = setInterval(() => {
        if (Date.now() - lastSave > saveFrequency) {
          saveGame();
          lastSave = Date.now();
        }
      }, saveFrequency);
    }

    function startMessageChecking() {
      // Clear any existing interval
      if (messageCheckInterval) clearInterval(messageCheckInterval);
      
      // Check for messages every 30 seconds
      messageCheckInterval = setInterval(() => {
        checkForBroadcastMessages();
      }, 30000);
      
      // Initial check
      checkForBroadcastMessages();
    }

    async function saveGame() {
      try {
        const gameData = {
          coins,
          coinsPerClick,
          coinsPerSecond,
          highestVisibleUpgrade,
          rebirthMultiplier,
          rebirthCount,
          upgrades: upgrades.map(u => ({ id: u.id, owned: u.owned })),
          clickUpgrades: clickUpgrades.map(cu => ({ id: cu.id, purchased: cu.purchased })),
          username: playerUsername,
          avatar: playerPicture || "",
          id: userId,
          lastUpdated: Date.now()
        };

        // Save locally with user ID prefix (or 'guest' for guest mode)
        const saveKey = `businessEmpireSave_${userId || 'guest'}`;
        localStorage.setItem(saveKey, JSON.stringify(gameData));

        // Save to JSONbin if signed in
        if (isSignedIn && userId) {
          const now = Date.now();
          const lastSaved = localStorage.getItem('lastCloudSave') || 0;
          
          // Only save to cloud every 10 minutes to avoid API limits
          if (now - lastSaved > leaderboardUpdateInterval) {
            try {
              // Get current leaderboard data
              const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                headers: {
                  'X-Master-Key': JSONBIN_API_KEY
                }
              });
              
              let allData = { players: [], bannedUsers: [] };
              if (response.ok) {
                const data = await response.json();
                allData.players = data.record.players || [];
                allData.bannedUsers = data.record.bannedUsers || [];
              } else {
                throw new Error(`API Error: ${response.status}`);
              }
              
              // Update or add current player
              const existingPlayerIndex = allData.players.findIndex(p => p.id === userId);
              if (existingPlayerIndex >= 0) {
                allData.players[existingPlayerIndex] = gameData;
              } else {
                allData.players.push(gameData);
              }
              
              // Save back to JSONbin
              const saveResponse = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Master-Key': JSONBIN_API_KEY
                },
                body: JSON.stringify(allData)
              });
              
              if (!saveResponse.ok) {
                throw new Error(`Save Error: ${saveResponse.status}`);
              }
              
              localStorage.setItem('lastCloudSave', now);
            } catch (error) {
              console.error("Error saving to leaderboard:", error);
            }
          }
        }
      } catch (error) {
        console.error("Error saving game:", error);
      }
    }

    function loadGame() {
      try {
        // Check if we have a saved game for this user (or guest)
        const saveKey = `businessEmpireSave_${userId || 'guest'}`;
        const localSave = localStorage.getItem(saveKey);
        if (localSave) {
          const savedData = JSON.parse(localSave);
          loadGameData(savedData);
        } else {
          // No saved game - start fresh
          resetGameState();
        }
        
        // Try to load cached leaderboard data
        const cached = localStorage.getItem('leaderboardCache');
        if (cached) {
          const parsed = JSON.parse(cached);
          leaderboardData = parsed.data || [];
          lastLeaderboardUpdate = parsed.timestamp || 0;
        }
        
        // Load admin settings
        const autoUpdate = localStorage.getItem('leaderboardAutoUpdate');
        if (autoUpdate !== null) {
          leaderboardAutoUpdate = autoUpdate === 'true';
          document.getElementById('leaderboardToggle').checked = leaderboardAutoUpdate;
        }
      } catch (error) {
        console.error("Error loading game:", error);
        resetGameState();
      }
    }
    
    function resetGameState() {
      coins = 0;
      coinsPerClick = 1;
      coinsPerSecond = 0;
      highestVisibleUpgrade = 3;
      rebirthMultiplier = 1;
      rebirthCount = 0;
      
      // Reset upgrades
      upgrades.forEach(upgrade => {
        upgrade.owned = 0;
      });
      
      // Reset click upgrades
      clickUpgrades.forEach(upgrade => {
        upgrade.purchased = false;
      });
      
      updateDisplay();
      renderUpgrades();
      renderClickUpgrades();
    }
    
    function loadGameData(gameData) {
      if (!gameData) return;
      
      coins = gameData.coins || 0;
      coinsPerClick = gameData.coinsPerClick || 1;
      coinsPerSecond = gameData.coinsPerSecond || 0;
      highestVisibleUpgrade = gameData.highestVisibleUpgrade || 3;
      rebirthMultiplier = gameData.rebirthMultiplier || 1;
      rebirthCount = gameData.rebirthCount || 0;
      
      // Merge upgrades
      if (gameData.upgrades) {
        gameData.upgrades.forEach(savedUpgrade => {
          const existingUpgrade = upgrades.find(u => u.id === savedUpgrade.id);
          if (existingUpgrade) {
            existingUpgrade.owned = savedUpgrade.owned || 0;
          }
        });
      }
      
      if (gameData.clickUpgrades) {
        gameData.clickUpgrades.forEach(savedClickUpgrade => {
          const existingClickUpgrade = clickUpgrades.find(cu => cu.id === savedClickUpgrade.id);
          if (existingClickUpgrade) {
            existingClickUpgrade.purchased = savedClickUpgrade.purchased || false;
          }
        });
      }
      
      updateDisplay();
      renderUpgrades();
      renderClickUpgrades();
    }

    // ======================
    // LEADERBOARD SYSTEM
    // ======================
    async function updateLeaderboard() {
      const now = Date.now();
      
      // Only fetch from API if data is stale (older than 10 minutes) and auto-update is on
      if (now - lastLeaderboardUpdate > leaderboardUpdateInterval && leaderboardAutoUpdate) {
        const leaderboardList = document.getElementById("leaderboardList");
        leaderboardList.innerHTML = '<div class="loading-spinner"></div>';
        
        try {
          const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: {
              'X-Master-Key': JSONBIN_API_KEY
            }
          });
          
          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }
          
          const data = await response.json();
          leaderboardData = data.record.players || [];
          lastLeaderboardUpdate = now;
          
          // Clean duplicate usernames
          cleanDuplicateUsernames();
          
          // Cache locally
          localStorage.setItem('leaderboardCache', JSON.stringify({
            data: leaderboardData,
            timestamp: lastLeaderboardUpdate
          }));
        } catch (error) {
          console.error("Error loading leaderboard:", error);
          // Load from cache if API fails
          loadFromCache();
        }
      }
      
      updateLeaderboardDisplay();
      startCountdown();
    }

    function cleanDuplicateUsernames() {
      const usernameMap = {};
      const cleanedData = [];
      
      leaderboardData.forEach(user => {
        if (user.username) {
          const lowerUsername = user.username.toLowerCase();
          if (usernameMap[lowerUsername]) {
            // Duplicate found - reset this user's username
            if (usernameMap[lowerUsername] !== user.id) {
              user.username = "";
              
              // Remove from local storage if exists
              const userKey = `user_${user.id}`;
              const userData = JSON.parse(localStorage.getItem(userKey) || '{}');
              if (userData.username) {
                delete userData.username;
                localStorage.setItem(userKey, JSON.stringify(userData));
              }
            }
          } else {
            usernameMap[lowerUsername] = user.id;
          }
        }
        cleanedData.push(user);
      });
      
      leaderboardData = cleanedData;
    }

    function loadFromCache() {
      const cached = localStorage.getItem('leaderboardCache');
      if (cached) {
        const parsed = JSON.parse(cached);
        leaderboardData = parsed.data || [];
        lastLeaderboardUpdate = parsed.timestamp || 0;
      } else {
        leaderboardData = [];
      }
    }

    function updateLeaderboardDisplay() {
      const leaderboardList = document.getElementById("leaderboardList");
      
      if (leaderboardData.length === 0) {
        leaderboardList.innerHTML = '<p>No leaderboard data available</p>';
        return;
      }

      // Sort based on rebirths first, then coins
      const sortedData = [...leaderboardData].sort((a, b) => {
        // First sort by rebirths (descending)
        if ((b.rebirthCount || 0) !== (a.rebirthCount || 0)) {
          return (b.rebirthCount || 0) - (a.rebirthCount || 0);
        }
        // If rebirths are equal, sort by coins (descending)
        return (b.coins || 0) - (a.coins || 0);
      });

      renderLeaderboard(sortedData);
    }

    function renderLeaderboard(data) {
      const leaderboardList = document.getElementById("leaderboardList");
      leaderboardList.innerHTML = '';

      // Filter out banned users and those with no coins or rebirths
      const filteredData = data.filter(user => {
        const isBanned = localStorage.getItem(`banned_${user.id}`) === 'true';
        return !isBanned && ((user.coins > 0 || user.rebirthCount > 0));
      });

      // Sort again after filtering (same logic as above)
      const sortedData = [...filteredData].sort((a, b) => {
        if ((b.rebirthCount || 0) !== (a.rebirthCount || 0)) {
          return (b.rebirthCount || 0) - (a.rebirthCount || 0);
        }
        return (b.coins || 0) - (a.coins || 0);
      });

      // Show top 20
      sortedData.slice(0, 20).forEach((entry, index) => {
        const entryEl = document.createElement('div');
        entryEl.className = 'leaderboard-entry';
        
        entryEl.innerHTML = `
          <div class="leaderboard-rank">${index + 1}</div>
          <div class="leaderboard-user">
            ${entry.avatar ? `<img src="${entry.avatar}" class="leaderboard-avatar" alt="${entry.username}">` : ''}
            <span>${entry.username || "Anonymous"}</span>
          </div>
          <div class="leaderboard-rebirths">${entry.rebirthCount || 0}</div>
          <div class="leaderboard-score">${Math.floor(entry.coins || 0).toLocaleString()}</div>
        `;

        // Highlight current user
        if (entry.id === userId) {
          entryEl.style.background = 'rgba(124, 58, 237, 0.15)';
          entryEl.style.borderLeft = '4px solid var(--primary)';
        }

        leaderboardList.appendChild(entryEl);
      });

      // Add current user if not in top 20
      if (userId && !sortedData.slice(0, 20).some(e => e.id === userId)) {
        const userEntry = leaderboardData.find(e => e.id === userId);
        if (userEntry) {
          const userPosition = sortedData.findIndex(e => e.id === userId);
          if (userPosition !== -1) {
            const entryEl = document.createElement('div');
            entryEl.className = 'leaderboard-entry';
            entryEl.style.background = 'rgba(124, 58, 237, 0.15)';
            entryEl.style.borderLeft = '4px solid var(--primary)';
            
            entryEl.innerHTML = `
              <div class="leaderboard-rank">${userPosition + 1}</div>
              <div class="leaderboard-user">
                ${userEntry.avatar ? `<img src="${userEntry.avatar}" class="leaderboard-avatar">` : ''}
                <span>${userEntry.username || "You"}</span>
              </div>
              <div class="leaderboard-rebirths">${userEntry.rebirthCount || 0}</div>
              <div class="leaderboard-score">${Math.floor(userEntry.coins || 0).toLocaleString()}</div>
            `;
            
            leaderboardList.appendChild(entryEl);
          }
        }
      }
      
      // Add headers
      const headerEl = document.createElement('div');
      headerEl.className = 'leaderboard-entry';
      headerEl.style.fontWeight = 'bold';
      headerEl.style.borderBottom = '2px solid var(--accent)';
      headerEl.style.background = 'var(--bg-darker)';
      headerEl.innerHTML = `
        <div class="leaderboard-rank">#</div>
        <div class="leaderboard-user">Player</div>
        <div class="leaderboard-rebirths">Rebirths</div>
        <div class="leaderboard-score">Coins</div>
      `;
      leaderboardList.insertBefore(headerEl, leaderboardList.firstChild);
    }
    
    function startCountdown() {
      const now = Date.now();
      const nextUpdate = lastLeaderboardUpdate + leaderboardUpdateInterval;
      const timeLeft = Math.max(0, nextUpdate - now);
      const leaderboardCountdown = document.getElementById("leaderboardCountdown");
      
      updateCountdownDisplay(timeLeft);
      
      // Update countdown every second
      const countdownInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = Math.max(0, nextUpdate - now);
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          leaderboardCountdown.textContent = "Updating leaderboard...";
          // Refresh the leaderboard
          lastLeaderboardUpdate = 0;
          updateLeaderboard();
        } else {
          updateCountdownDisplay(timeLeft);
        }
      }, 1000);
    }
    
    function updateCountdownDisplay(ms) {
      const minutes = Math.floor(ms / (60 * 1000));
      const seconds = Math.floor((ms % (60 * 1000)) / 1000);
      document.getElementById("leaderboardCountdown").textContent = `Next update in: ${minutes}m ${seconds}s`;
    }

    // ======================
    // ADMIN PANEL FUNCTIONS
    // ======================
    async function loadUserList() {
      const userList = document.getElementById("userList");
      const userStatus = document.getElementById("userStatus");
      
      userList.innerHTML = '<div class="loading-spinner"></div>';
      userStatus.textContent = '';
      
      try {
        // Try to get fresh data first
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        leaderboardData = data.record.players || [];
        lastLeaderboardUpdate = Date.now();
        localStorage.setItem('leaderboardCache', JSON.stringify({
          data: leaderboardData,
          timestamp: lastLeaderboardUpdate
        }));
      } catch (error) {
        console.error("Error loading leaderboard:", error);
        // Try to load from cache if API fails
        const cached = localStorage.getItem('leaderboardCache');
        if (cached) {
          const parsed = JSON.parse(cached);
          leaderboardData = parsed.data || [];
        } else {
          leaderboardData = [];
        }
      }
      
      renderUserList();
    }
    
    function renderUserList() {
      const userList = document.getElementById("userList");
      userList.innerHTML = '';
      
      if (leaderboardData.length === 0) {
        userList.innerHTML = '<p>No user data available</p>';
        return;
      }
      
      // Sort users by rebirths then coins
      const sortedUsers = [...leaderboardData].sort((a, b) => {
        if ((b.rebirthCount || 0) !== (a.rebirthCount || 0)) {
          return (b.rebirthCount || 0) - (a.rebirthCount || 0);
        }
        return (b.coins || 0) - (a.coins || 0);
      });
      
      sortedUsers.forEach(user => {
        const isBanned = localStorage.getItem(`banned_${user.id}`) === 'true';
        
        const userEl = document.createElement('div');
        userEl.className = 'admin-user';
        
        userEl.innerHTML = `
          <div class="admin-user-info">
            <img src="${user.avatar || 'https://via.placeholder.com/32'}" class="admin-user-avatar" alt="${user.username}">
            <span class="admin-username">${user.username || "Anonymous"}</span>
          </div>
          <div class="admin-user-actions">
            <button class="admin-action-btn edit-btn" data-id="${user.id}">Edit</button>
            ${isBanned ? 
              `<button class="admin-action-btn unban-btn" data-id="${user.id}">Unban</button>` : 
              `<button class="admin-action-btn ban-btn" data-id="${user.id}">Ban</button>`
            }
          </div>
        `;
        
        userList.appendChild(userEl);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.ban-btn').forEach(btn => {
        btn.addEventListener('click', () => banUser(btn.dataset.id));
      });
      
      document.querySelectorAll('.unban-btn').forEach(btn => {
        btn.addEventListener('click', () => unbanUser(btn.dataset.id));
      });
      
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editUser(btn.dataset.id));
      });
    }
    
    async function banUser(userId) {
      try {
        // First ban locally
        localStorage.setItem(`banned_${userId}`, 'true');
        
        // Then ban in cloud
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        let allData = { players: [], bannedUsers: [] };
        if (response.ok) {
          const data = await response.json();
          allData.players = data.record.players || [];
          allData.bannedUsers = data.record.bannedUsers || [];
        }
        
        // Add user to banned list if not already there
        if (!allData.bannedUsers.includes(userId)) {
          allData.bannedUsers.push(userId);
          
          // Save back to JSONbin
          await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-Master-Key': JSONBIN_API_KEY
            },
            body: JSON.stringify(allData)
          });
        }
        
        const userStatus = document.getElementById("userStatus");
        userStatus.textContent = 'User banned successfully';
        userStatus.className = 'admin-status success';
        
        // Update both admin panel and leaderboard immediately
        renderUserList();
        if (document.getElementById("leaderboardModal").style.display === 'flex') {
          updateLeaderboardDisplay();
        }
        
        // If banning current user, show banned message
        if (userId === this.userId) {
          showBannedMessage();
        }
      } catch (error) {
        console.error("Error banning user:", error);
        const userStatus = document.getElementById("userStatus");
        userStatus.textContent = 'Error banning user';
        userStatus.className = 'admin-status error';
      }
    }
    
    async function unbanUser(userId) {
      try {
        // First unban locally
        localStorage.removeItem(`banned_${userId}`);
        
        // Then unban in cloud
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        let allData = { players: [], bannedUsers: [] };
        if (response.ok) {
          const data = await response.json();
          allData.players = data.record.players || [];
          allData.bannedUsers = data.record.bannedUsers || [];
        }
        
        // Remove user from banned list if exists
        const bannedIndex = allData.bannedUsers.indexOf(userId);
        if (bannedIndex !== -1) {
          allData.bannedUsers.splice(bannedIndex, 1);
          
          // Save back to JSONbin
          await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-Master-Key': JSONBIN_API_KEY
            },
            body: JSON.stringify(allData)
          });
        }
        
        const userStatus = document.getElementById("userStatus");
        userStatus.textContent = 'User unbanned successfully';
        userStatus.className = 'admin-status success';
        
        // Update both admin panel and leaderboard immediately
        renderUserList();
        if (document.getElementById("leaderboardModal").style.display === 'flex') {
          updateLeaderboardDisplay();
        }
      } catch (error) {
        console.error("Error unbanning user:", error);
        const userStatus = document.getElementById("userStatus");
        userStatus.textContent = 'Error unbanning user';
        userStatus.className = 'admin-status error';
      }
    }
    
    function editUser(userId) {
      try {
        const user = leaderboardData.find(u => u.id === userId);
        if (!user) return;
        
        const newCoins = prompt(`Enter new coins for ${user.username || 'user'}:`, user.coins || 0);
        if (newCoins === null) return;
        
        const coinsValue = newCoins.toLowerCase() === 'infinity' ? Infinity : parseFloat(newCoins);
        if (isNaN(coinsValue)) {
          const userStatus = document.getElementById("userStatus");
          userStatus.textContent = 'Invalid coin amount';
          userStatus.className = 'admin-status error';
          return;
        }
        
        const newRebirths = prompt(`Enter new rebirth count for ${user.username || 'user'}:`, user.rebirthCount || 0);
        if (newRebirths === null) return;
        
        const rebirthsValue = parseInt(newRebirths);
        if (isNaN(rebirthsValue)) {
          const userStatus = document.getElementById("userStatus");
          userStatus.textContent = 'Invalid rebirth count';
          userStatus.className = 'admin-status error';
          return;
        }
        
        user.coins = coinsValue;
        user.rebirthCount = rebirthsValue;
        
        // Update local data
        const cached = localStorage.getItem('leaderboardCache');
        if (cached) {
          const parsed = JSON.parse(cached);
          const userIndex = parsed.data.findIndex(u => u.id === userId);
          if (userIndex !== -1) {
            parsed.data[userIndex].coins = coinsValue;
            parsed.data[userIndex].rebirthCount = rebirthsValue;
            localStorage.setItem('leaderboardCache', JSON.stringify(parsed));
          }
        }
        
        // Update displayed data
        const userIndex = leaderboardData.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          leaderboardData[userIndex].coins = coinsValue;
          leaderboardData[userIndex].rebirthCount = rebirthsValue;
        }
        
        // Update cloud data if this is the current user
        if (userId === this.userId) {
          coins = coinsValue;
          rebirthCount = rebirthsValue;
          updateDisplay();
          saveGame();
        }
        
        const userStatus = document.getElementById("userStatus");
        userStatus.textContent = `Updated ${user.username || 'user'}'s stats`;
        userStatus.className = 'admin-status success';
        
        // Update leaderboard display if open
        if (document.getElementById("leaderboardModal").style.display === 'flex') {
          updateLeaderboardDisplay();
        }
        
        // Update user list
        renderUserList();
      } catch (error) {
        console.error("Error editing user:", error);
      }
    }
    
    async function sendBroadcastMessage() {
      const adminMessage = document.getElementById("adminMessage");
      const messageStatus = document.getElementById("messageStatus");
      
      const message = adminMessage.value.trim();
      if (!message) {
        messageStatus.textContent = 'Please enter a message';
        messageStatus.className = 'admin-status error';
        return;
      }
      
      try {
        const sendBtn = document.getElementById("sendMessageBtn");
        sendBtn.classList.add('btn-loading');
        sendBtn.disabled = true;
        
        // Save message to cloud
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        let allData = { players: [], bannedUsers: [], broadcastMessage: null };
        if (response.ok) {
          const data = await response.json();
          allData.players = data.record.players || [];
          allData.bannedUsers = data.record.bannedUsers || [];
        }
        
        // Add broadcast message
        allData.broadcastMessage = {
          text: message,
          timestamp: Date.now()
        };
        
        // Save back to JSONbin
        await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_API_KEY
          },
          body: JSON.stringify(allData)
        });
        
        messageStatus.textContent = 'Message sent to all players';
        messageStatus.className = 'admin-status success';
        adminMessage.value = '';
        
        // Show the message immediately
        showBroadcastMessage(message);
      } catch (error) {
        console.error("Error sending message:", error);
        messageStatus.textContent = 'Error sending message';
        messageStatus.className = 'admin-status error';
      } finally {
        const sendBtn = document.getElementById("sendMessageBtn");
        sendBtn.classList.remove('btn-loading');
        sendBtn.disabled = false;
      }
    }
    
    async function checkForBroadcastMessages() {
      try {
        // Only check every 30 seconds
        const now = Date.now();
        if (now - lastBroadcastCheck < 30000) return;
        lastBroadcastCheck = now;
        
        // Get broadcast message from cloud
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const broadcast = data.record.broadcastMessage;
          
          if (broadcast && broadcast.text) {
            // Check if this is a new message (not the same as last shown)
            const lastShownMessage = localStorage.getItem('lastShownMessage');
            if (!lastShownMessage || lastShownMessage !== broadcast.text) {
              showBroadcastMessage(broadcast.text);
              localStorage.setItem('lastShownMessage', broadcast.text);
            }
          }
        }
      } catch (error) {
        console.error("Error checking for broadcast messages:", error);
      }
    }
    
    function showBroadcastMessage(message) {
      // Remove any existing broadcast message
      const existingMessage = document.getElementById('broadcastMessage');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // Create new broadcast message display
      const broadcastEl = document.createElement('div');
      broadcastEl.id = 'broadcastMessage';
      broadcastEl.className = 'broadcast-message';
      broadcastEl.textContent = message;
      document.body.appendChild(broadcastEl);
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        broadcastEl.remove();
      }, 3000);
    }
    
    function saveAdminSettings() {
      try {
        leaderboardAutoUpdate = document.getElementById("leaderboardToggle").checked;
        localStorage.setItem('leaderboardAutoUpdate', leaderboardAutoUpdate.toString());
        
        const settingsStatus = document.getElementById("settingsStatus");
        settingsStatus.textContent = 'Settings saved successfully';
        settingsStatus.className = 'admin-status success';
        
        setTimeout(() => {
          settingsStatus.textContent = '';
          settingsStatus.className = 'admin-status';
        }, 2000);
      } catch (error) {
        console.error("Error saving settings:", error);
      }
    }

    // ======================
    // REFRESH SYSTEM
    // ======================
    function setupAutoRefresh() {
      // Auto-refresh every 15 minutes (900,000 ms)
      setTimeout(() => {
        location.reload();
      }, 900000);
      
      // Manual refresh button in admin panel
      document.getElementById('refreshBtn').addEventListener('click', () => {
        // Force immediate refresh for everyone
        localStorage.setItem('forceRefresh', 'true');
        location.reload();
      });
    }

    // ======================
    // GAME FUNCTIONS
    // ======================
    function gameLoop() {
      coins += coinsPerSecond;
      updateDisplay();
      checkForNewUpgrades();
      renderUpgrades();
      renderClickUpgrades();
      saveGame(); // Auto-save
    }
    
    function createFallingCoin() {
      const coin = document.createElement('img');
      coin.className = 'falling-coin';
      
      // Choose random coin image (50/50 chance)
      const coinType = Math.random() < 0.5 ? 0 : 1;
      coin.src = coinImages[coinType];
      
      // Random horizontal position
      const xPos = Math.random() * 100;
      coin.style.left = `${xPos}%`;
      
      // Random animation duration (2-4 seconds)
      const duration = 2 + Math.random() * 2;
      coin.style.animationDuration = `${duration}s`;
      
      // Random size (30-50px)
      const size = 30 + Math.random() * 20;
      coin.style.width = `${size}px`;
      coin.style.height = `${size}px`;
      
      // Random rotation speed
      const rotation = Math.random() * 360;
      coin.style.transform = `rotate(${rotation}deg)`;
      
      document.body.appendChild(coin);
      
      // Remove coin after animation completes
      setTimeout(() => {
        coin.remove();
      }, duration * 1000);
    }
    
    function handleClick() {
      coins += coinsPerClick;
      updateDisplay();
      checkForNewUpgrades();
      saveGame();
      
      // Create falling coin
      createFallingCoin();
      
      // Visual feedback
      const coinsDisplay = document.getElementById("coins");
      coinsDisplay.classList.add("pulse");
      setTimeout(() => coinsDisplay.classList.remove("pulse"), 300);
    }
    
    function updateDisplay() {
      document.getElementById("coins").textContent = Math.floor(coins).toLocaleString();
      document.getElementById("cps").textContent = `${coinsPerSecond.toFixed(1)} coins/sec`;
      updateClickerText();
    }
    
    function updateClickerText() {
      document.getElementById("clicker").textContent = `Earn Coins (${(coinsPerClick * rebirthMultiplier).toLocaleString()} per click)`;
    }
    
    function checkForNewUpgrades() {
      for (let i = 0; i < upgrades.length; i++) {
        const upgrade = upgrades[i];
        const cost = getUpgradeCost(upgrade);
        
        // Show next upgrade when player has 25% of current upgrade's cost
        if (i > highestVisibleUpgrade && coins >= cost * 0.25) {
          highestVisibleUpgrade = i;
          renderUpgrades(); // Immediately show the new upgrade
        }
      }
    }
    
    function renderUpgrades() {
      const upgradesContainer = document.getElementById("upgrades");
      upgradesContainer.innerHTML = "";
      
      const visibleUpgrades = upgrades.slice(0, highestVisibleUpgrade + 1);
      
      visibleUpgrades.forEach(upgrade => {
        const cost = getUpgradeCost(upgrade);
        const canAfford = coins >= cost;
        
        const upgradeEl = document.createElement("div");
        upgradeEl.className = `upgrade ${canAfford ? "unlocked" : "locked"}`;
        upgradeEl.setAttribute('data-id', upgrade.id);
        
        const progress = Math.min(1, coins / cost);
        
        upgradeEl.innerHTML = `
          <div class="upgrade-name">${upgrade.name}</div>
          <div class="upgrade-desc">${upgrade.desc}</div>
          <div>
            <span class="upgrade-cost">${cost.toLocaleString()} coins</span>
            <span class="upgrade-owned">Owned: ${upgrade.owned}</span>
          </div>
          <div class="progress-bar">
            <div class="progress" style="width: ${progress * 100}%"></div>
          </div>
        `;
        
        upgradesContainer.appendChild(upgradeEl);
      });
    }
    
    function renderClickUpgrades() {
      const clickUpgradesGrid = document.getElementById("clickUpgradesGrid");
      clickUpgradesGrid.innerHTML = "";
      
      clickUpgrades.forEach(upgrade => {
        const canAfford = coins >= upgrade.cost && !upgrade.purchased;
        
        const upgradeEl = document.createElement("div");
        upgradeEl.className = `click-upgrade ${canAfford ? "unlocked" : "locked"}`;
        upgradeEl.setAttribute('data-id', upgrade.id);
        
        upgradeEl.innerHTML = `
          <div class="click-upgrade-name">${upgrade.name}</div>
          <div class="click-upgrade-desc">+${(upgrade.amount * rebirthMultiplier).toLocaleString()} coins per click</div>
          <div class="click-upgrade-cost">${upgrade.cost.toLocaleString()} coins</div>
          ${upgrade.purchased ? '<div class="click-upgrade-owned">Purchased</div>' : ''}
        `;
        
        clickUpgradesGrid.appendChild(upgradeEl);
      });
    }
    
    function buyUpgrade(id) {
      const upgrade = upgrades.find(u => u.id === id);
      const cost = getUpgradeCost(upgrade);
      
      if (coins >= cost) {
        coins -= cost;
        upgrade.owned++;
        
        // Special handling for DEATH upgrade
        if (upgrade.name === "DEATH") {
          triggerRebirth();
          return;
        }
        
        coinsPerSecond += upgrade.effect * rebirthMultiplier;
        updateDisplay();
        renderUpgrades();
        saveGame();
        
        // Visual feedback
        const upgradeEl = document.querySelector(`.upgrade[data-id="${id}"]`);
        if (upgradeEl) {
          upgradeEl.classList.add('purchase-effect');
          setTimeout(() => upgradeEl.classList.remove('purchase-effect'), 300);
        }
      }
    }
    
    function buyClickUpgrade(id) {
      const upgrade = clickUpgrades.find(u => u.id === id);
      
      if (!upgrade.purchased && coins >= upgrade.cost) {
        coins -= upgrade.cost;
        coinsPerClick += upgrade.amount * rebirthMultiplier;
        upgrade.purchased = true;
        updateDisplay();
        renderClickUpgrades();
        saveGame();
        
        // Visual feedback
        const upgradeEl = document.querySelector(`.click-upgrade[data-id="${id}"]`);
        if (upgradeEl) {
          upgradeEl.classList.add('purchase-effect');
          setTimeout(() => upgradeEl.classList.remove('purchase-effect'), 300);
        }
      }
    }
    
    function triggerRebirth() {
      // Increment rebirth count
      rebirthCount++;
      
      // Reset all game state
      coins = 0;
      coinsPerClick = 1;
      coinsPerSecond = 0;
      highestVisibleUpgrade = 3;
      
      // Reset all upgrades
      upgrades.forEach(upgrade => {
        upgrade.owned = 0;
      });
      
      // Reset click upgrades
      clickUpgrades.forEach(upgrade => {
        upgrade.purchased = false;
      });
      
      // Increase rebirth multiplier
      rebirthMultiplier *= 2;
      
      // Save immediately
      saveGame();
      
      // Update displays
      updateDisplay();
      renderUpgrades();
      renderClickUpgrades();
      
      // Show rebirth animation
      for (let i = 0; i < 20; i++) {
        setTimeout(() => createFallingCoin(), i * 100);
      }
    }
    
    function redeemCode() {
      const codeInput = document.getElementById("codeInput");
      const codeMessage = document.getElementById("codeMessage");
      
      const code = codeInput.value.trim();
      
      if (code === "yugpatel2009") {
        coins = Infinity;
        coinsPerClick = Infinity;
        coinsPerSecond = Infinity;
        updateDisplay();
        codeMessage.textContent = "Success! Infinite coins granted!";
        codeMessage.style.color = "var(--accent-light)";
        saveGame();
        
        // Close modal after 2 seconds
        setTimeout(() => {
          document.getElementById("codeModal").style.display = "none";
          codeMessage.textContent = "";
          codeInput.value = "";
        }, 2000);
      } else {
        codeMessage.textContent = "Invalid code!";
        codeMessage.style.color = "#ff6b6b";
      }
    }
    
    function getUpgradeCost(upgrade) {
      return Math.floor(upgrade.baseCost * Math.pow(1.5, upgrade.owned));
    }

    // ======================
    // EVENT LISTENERS
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Check for forced refresh
        if (localStorage.getItem('forceRefresh') === 'true') {
          localStorage.removeItem('forceRefresh');
          showBroadcastMessage("Game refreshed by admin");
        }
        
        // Load saved user if exists
        const savedUser = localStorage.getItem('googleUser');
        if (savedUser) {
          const user = JSON.parse(savedUser);
          playerName = user.name;
          playerEmail = user.email;
          playerPicture = user.picture;
          userId = user.id;
          isSignedIn = true;
          
          // First check if user is banned
          checkBanStatus().then(isBanned => {
            if (isBanned) {
              showBannedMessage();
              return;
            }
            
            // Check if admin
            if (playerEmail === "yhpatel@lcstudents.com") {
              isAdmin = true;
              document.getElementById('adminBtn').style.display = "block";
            }
            
            // Update UI
            document.querySelector('.g_id_signin').style.display = 'none';
            document.getElementById('signOutBtn').style.display = "block";
            
            // Load username if exists
            const userData = localStorage.getItem(`user_${userId}`);
            if (userData) {
              const user = JSON.parse(userData);
              playerUsername = user.username || playerName;
              usernameChanges = user.usernameChanges || 0;
              updateUserDisplay();
            }
            
            // Start auto-save and message checking
            startAutoSave();
            startMessageChecking();
            
            // Show tutorial if first time
            if (!hasSeenTutorial) {
              showTutorial();
            }
          });
        }
        
        // Initialize game
        highestVisibleUpgrade = 3; // Show first few upgrades by default
        renderUpgrades();
        renderClickUpgrades();
        setInterval(gameLoop, 1000);
        updateClickerText();
        loadGame();
        
        // Check for broadcast messages
        checkForBroadcastMessages();
        
        // Set up auto-refresh
        setupAutoRefresh();
        
        // Add all button event listeners
        setupEventListeners();
      } catch (error) {
        console.error("Error initializing game:", error);
      }
    });

    function setupEventListeners() {
      // Button listeners
      document.getElementById('upgradeClicksBtn').addEventListener('click', () => {
        document.getElementById("clickUpgradesModal").style.display = "flex";
      });
      
      document.getElementById('codeBtn').addEventListener('click', () => {
        document.getElementById("codeModal").style.display = "flex";
      });
      
      document.getElementById('leaderboardBtn').addEventListener('click', () => {
        document.getElementById("leaderboardModal").style.display = "flex";
        updateLeaderboard();
      });
      
      document.getElementById('signOutBtn').addEventListener('click', signOut);
      
      document.getElementById('adminBtn').addEventListener('click', () => {
        document.getElementById("adminPanel").style.display = "flex";
        loadUserList();
      });
      
      document.getElementById('saveUsernameBtn').addEventListener('click', saveUsername);
      
      document.getElementById('closeAdminPanel').addEventListener('click', () => {
        document.getElementById("adminPanel").style.display = "none";
      });
      
      // Tutorial buttons
      document.getElementById('skipTutorial').addEventListener('click', closeTutorial);
      document.getElementById('nextTutorial').addEventListener('click', closeTutorial);
      
      // Admin panel tab switching
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          
          document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.remove("active");
          });
          document.getElementById(`${tab.dataset.tab}Tab`).classList.add("active");
        });
      });
      
      // Admin panel user search
      document.getElementById('userSearch').addEventListener('input', () => {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const users = document.getElementById('userList').querySelectorAll(".admin-user");
        
        users.forEach(user => {
          const username = user.querySelector(".admin-username").textContent.toLowerCase();
          if (username.includes(searchTerm)) {
            user.style.display = "flex";
          } else {
            user.style.display = "none";
          }
        });
      });
      
      // Close modal listeners
      document.getElementById('closeClickUpgrades').addEventListener('click', () => {
        document.getElementById("clickUpgradesModal").style.display = "none";
      });
      
      document.getElementById('closeCodeModal').addEventListener('click', () => {
        document.getElementById("codeModal").style.display = "none";
      });
      
      document.getElementById('closeLeaderboard').addEventListener('click', () => {
        document.getElementById("leaderboardModal").style.display = "none";
      });
      
      // Code redemption
      document.getElementById('submitCode').addEventListener('click', redeemCode);
      document.getElementById('codeInput').addEventListener('keypress', (e) => {
        if (e.key === "Enter") {
          redeemCode();
        }
      });
      
      // Clicker button
      const clickerButton = document.getElementById('clicker');
      clickerButton.addEventListener('click', handleClick);
      clickerButton.addEventListener('touchstart', handleClick, {passive: true});
      
      // Username edit button
      document.getElementById('usernameContainer').addEventListener('click', () => {
        document.getElementById("usernameModal").style.display = "flex";
      });
      
      // Spacebar handling with cooldown
      document.addEventListener('keydown', (e) => {
        if (e.code === "Space" && !spacePressed && !spaceCooldown) {
          e.preventDefault();
          spacePressed = true;
          handleClick();
          
          // Visual feedback
          document.getElementById("clicker").classList.add("pulse");
          setTimeout(() => document.getElementById("clicker").classList.remove("pulse"), 300);
          
          // Cooldown
          spaceCooldown = true;
          setTimeout(() => spaceCooldown = false, 300);
        }
      });
      
      document.addEventListener('keyup', (e) => {
        if (e.code === "Space") {
          spacePressed = false;
        }
      });
      
      // Close any modal when clicking outside content
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
      
      // Upgrade click handlers
      document.addEventListener('click', function(e) {
        // Handle business upgrades
        if (e.target.closest('.upgrade.unlocked')) {
          const upgradeId = parseInt(e.target.closest('.upgrade').getAttribute('data-id'));
          buyUpgrade(upgradeId);
        }
        
        // Handle click upgrades
        if (e.target.closest('.click-upgrade.unlocked')) {
          const upgradeId = parseInt(e.target.closest('.click-upgrade').getAttribute('data-id'));
          buyClickUpgrade(upgradeId);
        }
      });
      
      // Admin panel actions
      document.getElementById('sendMessageBtn').addEventListener('click', sendBroadcastMessage);
      document.getElementById('saveSettingsBtn').addEventListener('click', saveAdminSettings);
    }
  </script>
</body>
</html>
